<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FIVE NIGHTS IN VRAJ</title>
<style>
    /* --- CSS RESET & BASICS --- */
    body {
        margin: 0; padding: 0;
        background-color: #000; color: #fff;
        font-family: 'Courier New', Courier, monospace;
        overflow: hidden; user-select: none;
        height: 100vh; width: 100vw;
    }
    .hidden { display: none !important; }
    .flex-center { display: flex; justify-content: center; align-items: center; }
    
    /* GLOBAL ATMOSPHERE */
    .scanlines {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 2px, 3px 100%;
        pointer-events: none; z-index: 999; opacity: 0.6;
    }
    .vignette {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.8) 100%);
        pointer-events: none; z-index: 900;
    }

    /* --- MENUS --- */
    #menu-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 1000; display: flex;
        overflow: hidden;
    }
    .menu-static-bg {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        opacity: 0.15; z-index: 0; pointer-events: none;
        animation: staticCycle 0.1s infinite steps(3);
    }
    .menu-left {
        width: 40%; height: 100%; display: flex; flex-direction: column;
        justify-content: center; padding-left: 50px; z-index: 1002;
    }
    .menu-title {
        font-family: "Impact", sans-serif; font-size: 4rem; color: #fff;
        text-shadow: 0 0 10px #fff; margin-bottom: 40px;
        border-left: 5px solid #3366ff; padding-left: 20px;
    }
    .menu-options { display: flex; flex-direction: column; gap: 15px; }
    button.menu-btn {
        background: transparent; border: none; color: #fff;
        font-family: "Impact", sans-serif; font-size: 2rem;
        text-align: left; cursor: pointer; transition: 0.1s;
        text-shadow: 2px 2px 0 #000;
    }
    button.menu-btn:hover { color: #3366ff; transform: translateX(10px); }
    .menu-night-display { font-size: 1.2rem; color: #888; margin-top: 20px; }
    .menu-right { width: 60%; height: 100%; position: relative; overflow: hidden; z-index: 1; }
    #menu-animatronic {
        position: absolute; top: 10%; right: 0; width: 90%; height: 90%;
        object-fit: contain; opacity: 0.8; filter: sepia(0.8) brightness(0.6);
    }
    .menu-copyright { position: absolute; bottom: 20px; right: 20px; color: #555; font-size: 0.8rem; z-index: 1002; }

    /* CUSTOM NIGHT MENU */
    #custom-night-menu {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 1100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .cn-grid { display: flex; gap: 20px; margin-bottom: 30px; }
    .cn-char { text-align: center; font-family: Impact, sans-serif; width: 100px; }
    .cn-img { width: 80px; height: 80px; object-fit: contain; border: 2px solid #555; margin-bottom: 10px; }
    .cn-input { background: #000; color: #fff; font-size: 2rem; width: 60px; text-align: center; border: 1px solid #fff; }
    .cn-btn { font-size: 2rem; padding: 10px 40px; cursor: pointer; border: 2px solid #fff; background: #000; color: #fff; font-family: Impact; }
    .cn-btn:hover { background: #fff; color: #000; }

    /* END SCREENS */
    #win-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .clock-box { font-family: "Impact"; font-size: 6rem; border: 4px solid #fff; padding: 20px; margin-bottom: 20px; }
    
    /* JUMPSCARE SCREEN */
    #game-over-screen {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: #000; z-index: 9999; display: none;
        justify-content: center; align-items: center; overflow: hidden;
    }
    
    #jumpscare-anim {
        width: 100%; height: 100%; 
        display: flex; justify-content: center; align-items: center;
        /* SCARIER LUNGE ANIMATION */
        animation: scaryLunge 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }
    
    @keyframes scaryLunge {
        0% { transform: scale(0.2) translateY(50px); opacity: 0; }
        20% { transform: scale(1.0) translateY(0); opacity: 1; }
        /* Violent Shaking */
        25% { transform: scale(1.05) translate(-5px, 5px) rotate(2deg); }
        30% { transform: scale(1.05) translate(5px, -5px) rotate(-2deg); }
        35% { transform: scale(1.05) translate(-5px, -5px) rotate(2deg); }
        40% { transform: scale(1.05) translate(5px, 5px) rotate(-2deg); }
        /* Final Zoom In */
        100% { transform: scale(1.15) translate(0,0) rotate(0deg); }
    }

    /* HELP OVERLAY */
    #help-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000 url('textures/help.png') no-repeat center center;
        background-size: contain;
        z-index: 3000; opacity: 0; display: none; pointer-events: none;
        transition: opacity 2s ease-in-out;
    }

    /* VIDEO PLAYER SCREEN */
    #video-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 4000; display: none;
        justify-content: center; align-items: center;
    }
    #intermission-video { width: 100%; height: 100%; object-fit: cover; }

    /* --- HUD (Z-Index 300 to sit OVER Camera) --- */
    #ui-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 300; 
    }
    .hud-text { position: absolute; font-size: 1.5rem; font-weight: bold; text-shadow: 1px 1px 0 #000; font-family: "Verdana", sans-serif; }
    #time-display { top: 20px; right: 30px; }
    #night-display { top: 50px; right: 30px; font-size: 1rem; }
    #power-display { bottom: 55px; left: 30px; }
    #usage-label { position: absolute; bottom: 25px; left: 30px; font-weight: bold; font-size: 1.2rem; font-family: "Verdana", sans-serif; }
    #usage-box { position: absolute; bottom: 28px; left: 110px; display: flex; gap: 4px; }
    .usage-bar { width: 15px; height: 20px; background: #222; border: 1px solid #555; }
    .usage-active { background: #0f0; box-shadow: 0 0 5px #0f0; }

    /* --- OFFICE --- */
    #office {
        width: 120vw; height: 100vh; 
        background: url('textures/office.png') no-repeat center center;
        background-size: cover; background-color: #1a1a1a;
        position: absolute; top: 0; left: 0;
    }
    .wall-section {
        position: absolute; top: 0; height: 100%; width: 18%; background: transparent;
        z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center;
        pointer-events: none; 
    }
    #wall-left { left: 0; } #wall-right { right: 0; }

    .control-panel {
        width: 60px; height: 120px; background: #ccc; border: 4px solid #555; border-radius: 5px;
        display: flex; flex-direction: column; justify-content: space-around; align-items: center;
        box-shadow: 5px 5px 15px #000; transform: perspective(500px) rotateY(5deg); pointer-events: auto;
    }
    .ctrl-btn {
        width: 40px; height: 40px; border-radius: 5px; cursor: pointer;
        border: 2px solid #888; font-size: 9px; font-weight: bold;
        display: flex; justify-content: center; align-items: center; color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .btn-door { background: #a00; border-radius: 50%; }
    .btn-light { background: #eee; color: #000; border-radius: 0; } 
    .btn-active-door { background: #600; box-shadow: inset 0 0 5px #000; border-color: #f00; }
    .btn-active-light { background: #aaf; box-shadow: 0 0 10px #fff; border-color: #fff; }

    .window-frame {
        width: 80%; height: 25%; background: transparent; border: 4px solid transparent; margin-bottom: 20px;
        position: relative; overflow: hidden; pointer-events: auto;
    }
    .window-glass {
        width: 100%; height: 100%; background: transparent; 
        position: relative; display: flex; justify-content: center; align-items: center;
        transition: background-color 0.1s ease-in-out;
    }
    .shadow-img { width: 90%; height: 90%; object-fit: contain; filter: brightness(0) blur(2px) opacity(0.95); transform: scale(0.9); }

    .doorway {
        position: absolute; top: 15%; height: 70%; width: 15%; background: #050505; z-index: 1;
        box-shadow: inset 0 0 80px #000; border-top: 5px solid #222;
        display: flex; justify-content: center; align-items: center;
        transition: background-color 0.1s ease-in-out;
    }
    #doorway-left { left: 18%; } #doorway-right { right: 18%; }
    .animatronic-full { width: 100%; height: 100%; object-fit: contain; filter: brightness(0.7); }
    
    .door-shutter {
        position: absolute; top: 0; left: 0; width: 100%; height: 0%;
        background: url('textures/door.png'), repeating-linear-gradient(90deg, #333, #333 10px, #444 10px, #444 20px);
        background-size: 100% 100%; transition: height 0.2s linear; border-bottom: 10px solid #555; z-index: 5;
    }
    .door-shutter.closed { height: 100%; }

    #monitor-panel {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 100%;
        background: #333; border: 20px solid #222; box-sizing: border-box;
        transform: translateY(100%); transition: transform 0.1s linear;
        z-index: 140; display: flex; justify-content: center; align-items: center; pointer-events: none;
    }
    #monitor-panel-inner { width: 90%; height: 90%; background: #111; border: 5px solid #555; }

    .trigger-bar {
        position: fixed; bottom: 0; left: 30%; width: 40%; height: 60px;
        z-index: 200; display: flex; justify-content: center; align-items: center;
        opacity: 0.3; transition: opacity 0.2s; cursor: pointer;
        border: 2px solid #555; background: rgba(255,255,255,0.05);
        border-top-left-radius: 10px; border-top-right-radius: 10px;
    }
    .trigger-bar:hover { opacity: 0.9; background: rgba(255,255,255,0.2); }
    .arrow-container { width: 100%; display: flex; justify-content: space-between; padding: 0 40px; }
    .trigger-arrow { color: #fff; font-family: Impact; font-size: 3rem; text-shadow: 2px 2px 0 #000; letter-spacing: -5px; }

    #golden-vraj {
        position: fixed; top: 10%; left: 10%; width: 80%; height: 80%;
        object-fit: contain; z-index: 120; display: none;
        filter: sepia(1) hue-rotate(40deg) brightness(1.2); animation: twitch 0.1s infinite;
    }
    @keyframes twitch { 0% { transform: translate(0,0); } 50% { transform: translate(2px, -2px); } }

    /* --- CAMERA SYSTEM UI --- */
    #camera-system {
        position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
        background: #000; z-index: 150; display: none;
    }
    
    #map-ui {
        position: absolute; bottom: 80px; right: 30px;
        width: 320px; height: 260px;
        z-index: 200;
    }
    #map-blueprint {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 190; pointer-events: none; opacity: 0.9; 
    }
    .line-style { fill: none; stroke: #eee; stroke-width: 3px; }

    .cam-btn {
        position: absolute; background: rgba(40, 40, 40, 0.6); border: 2px solid #bbb; color: #fff;
        font-family: Arial, sans-serif; font-weight: bold; font-size: 13px; 
        display: flex; justify-content: center; align-items: center; text-align: center;
        cursor: pointer; z-index: 200; transition: background 0.1s; box-sizing: border-box; 
    }
    .cam-btn:hover { background: rgba(80, 80, 80, 0.7); }
    .cam-selected { background: #adff2f !important; color: #000 !important; border-color: #fff !important; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.7; } }

    #btn-1A { top: 10px; left: 110px; width: 70px; height: 40px; } 
    #btn-1B { top: 60px; left: 100px; width: 90px; height: 50px; } 
    #btn-5  { top: 25px; left: 30px;  width: 55px; height: 35px; } 
    #btn-1C { top: 85px; left: 30px;  width: 45px; height: 45px; } 
    #btn-7  { top: 25px; left: 205px; width: 60px; height: 35px; } 
    #btn-6  { top: 80px; left: 215px; width: 60px; height: 45px; } 
    #btn-2A { top: 130px; left: 95px; width: 40px; height: 50px; } 
    #btn-2B { top: 195px; left: 95px; width: 40px; height: 35px; } 
    #btn-3  { top: 155px; left: 40px; width: 40px; height: 35px; } 
    #btn-4A { top: 130px; left: 155px; width: 40px; height: 50px; } 
    #btn-4B { top: 195px; left: 155px; width: 40px; height: 35px; } 

    #cam-feed { width: 100%; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; background-size: cover; background-position: center; }
    #cam-label { position: absolute; top: 30px; left: 30px; font-size: 2rem; border-left: 5px solid red; padding-left: 10px; text-shadow: 2px 2px #000; }
    #cam-content { font-size: 8rem; position: relative; display:flex; justify-content:center; align-items:center; width: 100%; height: 100%; }
    
    /* ANIMATED STATIC LAYERS */
    .static-anim {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-size: cover;
        pointer-events: none;
        z-index: 10;
        animation: staticCycle 0.08s infinite steps(3);
    }
    
    .static-opaque { opacity: 1; }
    .static-transparent { opacity: 0.3; }

    @keyframes staticCycle {
        0% { background-image: url('textures/static1.png'); }
        33% { background-image: url('textures/static2.png'); }
        66% { background-image: url('textures/static3.png'); }
        100% { background-image: url('textures/static1.png'); }
    }
</style>
</head>
<body>

<div class="scanlines"></div>
<div class="vignette"></div>

<div id="menu-screen">
    <div class="static-anim static-transparent" style="opacity: 0.15; z-index: 0;"></div>
    <div class="menu-left">
        <div class="menu-title">FIVE NIGHTS<br>IN VRAJ</div>
        <div class="menu-options">
            <button class="menu-btn" onclick="startNewGame()">New Game</button>
            <button class="menu-btn" onclick="continueGame()">Continue</button>
            <button class="menu-btn hidden" id="btn-custom" onclick="openCustomNight()">Custom Night</button>
            <div class="menu-night-display" id="menu-night-text">Night 1</div>
        </div>
    </div>
    <div class="menu-right"><img id="menu-animatronic" src="textures/vraj.png"></div>
</div>

<div id="help-overlay"></div>

<div id="transition-static" class="static-anim static-opaque" style="display:none; z-index: 9999;"></div>

<div id="custom-night-menu" class="hidden">
    <h1 style="font-family: Impact; font-size: 3rem; margin-bottom: 20px;">CUSTOM NIGHT</h1>
    <div class="cn-grid">
        <div class="cn-char"><div style="margin-bottom:5px;">BONNIE</div><input type="number" id="ai-bonnie" class="cn-input" min="0" max="20" value="0"></div>
        <div class="cn-char"><div style="margin-bottom:5px;">CHICA</div><input type="number" id="ai-chica" class="cn-input" min="0" max="20" value="0"></div>
        <div class="cn-char"><div style="margin-bottom:5px;">FREDDY</div><input type="number" id="ai-freddy" class="cn-input" min="0" max="20" value="0"></div>
        <div class="cn-char"><div style="margin-bottom:5px;">FOXY</div><input type="number" id="ai-foxy" class="cn-input" min="0" max="20" value="0"></div>
    </div>
    <button class="cn-btn" onclick="startCustomNight()">READY</button>
</div>

<div id="win-screen" class="hidden"><div class="clock-box" id="win-clock">5 AM</div><div style="font-family: Impact; font-size: 2rem; color: #888;">NIGHT COMPLETE</div></div>
<div id="game-over-screen">
    <div id="transition-static-death" class="static-anim static-opaque" style="z-index: 9999; display:none;"></div>
    <div id="jumpscare-anim" style="z-index: 2;"></div>
</div>
<img id="golden-vraj" src="textures/vraj.png">
<div id="monitor-panel"><div id="monitor-panel-inner"></div></div>

<div id="video-screen">
    <video id="intermission-video" style="width:100%; height:100%; object-fit:contain;"></video>
</div>

<div id="office">
    <div class="wall-section" id="wall-left">
        <div class="window-frame"><div class="window-glass" id="window-left"></div></div>
        <div class="control-panel">
            <div class="ctrl-btn btn-door" id="btn-door-left" onclick="toggleDoor('left')">DOOR</div>
            <div class="ctrl-btn btn-light" id="btn-light-left" onmousedown="toggleLight('left', true)" onmouseup="toggleLight('left', false)" onmouseleave="toggleLight('left', false)">LIGHT</div>
        </div>
    </div>
    <div class="doorway" id="doorway-left"><div class="door-shutter" id="shutter-left"></div><div id="hall-left" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;"></div></div>

    <div class="wall-section" id="wall-right">
        <div class="window-frame"><div class="window-glass" id="window-right"></div></div>
        <div class="control-panel">
            <div class="ctrl-btn btn-door" id="btn-door-right" onclick="toggleDoor('right')">DOOR</div>
            <div class="ctrl-btn btn-light" id="btn-light-right" onmousedown="toggleLight('right', true)" onmouseup="toggleLight('right', false)" onmouseleave="toggleLight('right', false)">LIGHT</div>
        </div>
    </div>
    <div class="doorway" id="doorway-right"><div class="door-shutter" id="shutter-right"></div><div id="hall-right" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;"></div></div>
</div>

<div class="trigger-bar" id="monitor-opener" onmouseenter="toggleMonitor()"><div class="arrow-container"><div class="trigger-arrow">&gt;&gt;</div><div class="trigger-arrow">&lt;&lt;</div></div></div>

<div id="ui-layer">
    <div id="time-display" class="hud-text">12 AM</div><div id="night-display" class="hud-text">Night 1</div>
    <div id="power-display" class="hud-text">Power: 100%</div><div id="usage-label">Usage:</div>
    <div id="usage-box"><div class="usage-bar" id="bar1"></div><div class="usage-bar" id="bar2"></div><div class="usage-bar" id="bar3"></div><div class="usage-bar" id="bar4"></div></div>
</div>

<div id="camera-system">
    <div class="static-anim static-transparent"></div>
    <div id="cam-feed"><div id="cam-label">CAM 1A</div><div id="cam-content"></div></div>
    
    <div id="map-ui">
        <svg id="map-blueprint">
            <line class="line-style" x1="145" y1="50" x2="145" y2="60" />
            <line class="line-style" x1="85" y1="40" x2="100" y2="70" />
            <line class="line-style" x1="205" y1="40" x2="190" y2="70" />
            <line class="line-style" x1="75" y1="100" x2="100" y2="90" />
            <line class="line-style" x1="215" y1="100" x2="190" y2="90" />
            <line class="line-style" x1="115" y1="110" x2="115" y2="130" />
            <line class="line-style" x1="175" y1="110" x2="175" y2="130" />
            <line class="line-style" x1="115" y1="180" x2="115" y2="195" />
            <line class="line-style" x1="175" y1="180" x2="175" y2="195" />
            <line class="line-style" x1="80" y1="170" x2="95" y2="155" />
        </svg>

        <div class="cam-btn cam-selected" id="btn-1A" onclick="switchCam('1A')">CAM 1A</div>
        <div class="cam-btn" id="btn-1B" onclick="switchCam('1B')">CAM 1B</div>
        <div class="cam-btn" id="btn-5" onclick="switchCam('5')">CAM 5</div>
        <div class="cam-btn" id="btn-1C" onclick="switchCam('1C')">CAM 1C</div>
        <div class="cam-btn" id="btn-7" onclick="switchCam('7')">CAM 7</div>
        <div class="cam-btn" id="btn-6" onclick="switchCam('6')">CAM 6</div>
        <div class="cam-btn" id="btn-2A" onclick="switchCam('2A')">CAM 2A</div>
        <div class="cam-btn" id="btn-3" onclick="switchCam('3')">CAM 3</div>
        <div class="cam-btn" id="btn-2B" onclick="switchCam('2B')">CAM 2B</div>
        <div class="cam-btn" id="btn-4A" onclick="switchCam('4A')">CAM 4A</div>
        <div class="cam-btn" id="btn-4B" onclick="switchCam('4B')">CAM 4B</div>
    </div>
    
    <div class="trigger-bar" style="z-index: 300;" onmouseenter="toggleMonitor()"><div class="arrow-container"><div class="trigger-arrow">&gt;&gt;</div><div class="trigger-arrow">&lt;&lt;</div></div></div>
</div>

<script>
    const GAME_HOUR_DURATION = 15000; const AI_MOVE_INTERVAL = 4000; const JUMPSCARE_DURATION = 5000; 
    
    // SOUND LOADING
    const sounds = {
        fan: new Audio('sounds/fan.mp3'),
        door: new Audio('sounds/door.mp3'),
        light: new Audio('sounds/light.mp3'),
        monitorUp: new Audio('sounds/monitor_up.mp3'),
        monitorDown: new Audio('sounds/monitor_down.mp3'),
        blip: new Audio('sounds/blip.mp3'),
        static: new Audio('sounds/static.mp3'),
        laugh: new Audio('sounds/laugh.mp3'),
        run: new Audio('sounds/run.mp3'),
        bang: new Audio('sounds/bang.mp3'),
        power: new Audio('sounds/power_out.mp3'),
        jump: new Audio('sounds/jumpscare.mp3'),
        win: new Audio('sounds/6am.mp3'),
        menuMusic: new Audio('sounds/menu_music.mp3') 
    };
    
    // CONFIGURATION
    sounds.fan.loop = true; 
    sounds.fan.volume = 0.05;
    
    sounds.static.loop = true; 
    sounds.static.volume = 0.3;
    
    sounds.light.loop = true; 
    sounds.menuMusic.loop = true; 

    let currentNight = parseInt(localStorage.getItem('vraj_night')) || 1;
    let lastToggleTime = 0; let mouseX = 0; let isCustomNight = false;
    let goldenVrajActive = false; let goldenTimer = null;

    const NIGHT_DIFFICULTY = { 1: [0,0,0,0], 2: [3,1,0,1], 3: [5,5,1,2], 4: [10,7,3,6], 5: [15,12,5,10], 6: [18,15,10,16] };
    let gameState = { active: false, hour: 0, power: 100, usage: 1, cameraOpen: false, currentCam: '1A', doors: {left:false,right:false}, lights: {left:false,right:false} };
    
    let animatronics = [
        { name: 'Bonnie', location: '1A', path: ['1A','1B','5','2A','3','2A','2B','door_left'], level: 0, filter: 'hue-rotate(220deg)' },
        { name: 'Chica',  location: '1A', path: ['1A','1B','7','6','4A','4B','door_right'], level: 0, filter: 'sepia(1) saturate(5) hue-rotate(50deg)' },
        { name: 'Freddy', location: '1A', path: ['1A','1B','7','6','4A','4B','door_right'], level: 0, filter: 'sepia(0.8) brightness(0.6)' },
        { name: 'Foxy',   location: '1C', path: ['1C','2A','door_left'], level: 0, stage: 0, filter: 'saturate(2)' } 
    ];
    let timerHour, timerPower, timerAI, timerMenuAnim;

    function playSound(name) { if(sounds[name]) { sounds[name].currentTime = 0; sounds[name].play().catch(()=>{}); } }

    // DEBUG CHEAT: Ctrl+Shift+O to Night 6
    document.addEventListener('keydown', (e) => {
        if(e.ctrlKey && e.shiftKey && e.code === 'KeyO') {
            localStorage.setItem('vraj_night', 6);
            location.reload();
        }
    });

    if(currentNight > 6) document.getElementById('btn-custom').classList.remove('hidden');
    document.getElementById('menu-night-text').innerText = `Night ${currentNight}`;

    // Start Menu Music
    document.body.addEventListener('click', () => {
        if(!gameState.active) sounds.menuMusic.play().catch(()=>{});
    }, {once:true});

    timerMenuAnim = setInterval(() => {
        const img = document.getElementById('menu-animatronic');
        img.style.opacity = (Math.random() > 0.8) ? Math.random() : 0.8;
    }, 100);

    function triggerTransitionStatic(callback) {
        const s = document.getElementById('transition-static');
        s.style.display = 'block';
        sounds.static.play();
        setTimeout(() => {
            s.style.display = 'none';
            sounds.static.pause();
            if(callback) callback();
        }, 500);
    }

    function startNewGame() { 
        triggerTransitionStatic(() => {
            currentNight = 1; localStorage.setItem('vraj_night', 1); isCustomNight = false; launchNight(); 
        });
    }
    
    function continueGame() { 
        if(currentNight > 5 && currentNight < 7) currentNight = 6; 
        isCustomNight = false; 
        triggerTransitionStatic(() => {
            launchNight(); 
        });
    }
    
    function openCustomNight() { document.getElementById('menu-screen').classList.add('hidden'); document.getElementById('custom-night-menu').classList.remove('hidden'); }
    
    function startCustomNight() {
        isCustomNight = true;
        let b = parseInt(document.getElementById('ai-bonnie').value)||0; let c = parseInt(document.getElementById('ai-chica').value)||0;
        let f = parseInt(document.getElementById('ai-freddy').value)||0; let x = parseInt(document.getElementById('ai-foxy').value)||0;
        NIGHT_DIFFICULTY[7] = [b,c,f,x]; currentNight = 7;
        document.getElementById('custom-night-menu').classList.add('hidden'); 
        triggerTransitionStatic(() => {
            launchNight();
        });
    }
    function returnToMenu() { location.reload(); }

    function launchNight() {
        clearInterval(timerMenuAnim);
        sounds.menuMusic.pause();
        sounds.menuMusic.currentTime = 0; // Stop Menu Music
        
        document.getElementById('menu-screen').classList.add('hidden'); 
        document.getElementById('win-screen').classList.add('hidden'); 
        document.getElementById('game-over-screen').style.display = 'none';
        
        let levels = NIGHT_DIFFICULTY[currentNight] || [20,20,20,20];
        animatronics.forEach((a, i) => a.level = levels[i]);
        
        resetGame();

        if (currentNight === 1 && !isCustomNight) {
            const help = document.getElementById('help-overlay');
            help.style.display = 'block';
            help.style.opacity = 1;
            
            setTimeout(() => {
                help.style.opacity = 0;
                setTimeout(() => {
                    help.style.display = 'none';
                    startGameLoop();
                }, 2000);
            }, 5000);
        } else {
            startGameLoop();
        }
    }

    function startGameLoop() {
        gameState.active = true;
        sounds.fan.play().catch(()=>{});
        timerHour = setInterval(updateTime, GAME_HOUR_DURATION); 
        timerPower = setInterval(updatePower, 500); 
        timerAI = setInterval(updateAI, AI_MOVE_INTERVAL);
        requestAnimationFrame(scrollLoop); 
        renderCamera();
    }

    function resetGame() {
        gameState = { active: false, hour: 0, power: 100, usage: 1, cameraOpen: false, currentCam: '1A', doors: {left:false,right:false}, lights: {left:false,right:false} };
        animatronics.forEach(a => a.location = '1A'); animatronics[3].location = '1C'; animatronics[3].stage = 0;
        goldenVrajActive = false; clearTimeout(goldenTimer); document.getElementById('golden-vraj').style.display = 'none';
        document.getElementById('night-display').innerText = isCustomNight ? "Custom Night" : `Night ${currentNight}`;
        document.getElementById('time-display').innerText = "12 AM"; document.getElementById('power-display').innerText = "Power: 100%";
        ['left', 'right'].forEach(side => {
            document.getElementById(`shutter-${side}`).classList.remove('closed');
            document.getElementById(`btn-door-${side}`).classList.remove('btn-active-door');
            document.getElementById(`btn-light-${side}`).classList.remove('btn-active-light');
            document.getElementById(`window-${side}`).style.backgroundColor = 'transparent';
            document.getElementById(`doorway-${side}`).style.backgroundColor = '#050505';
            document.getElementById(`window-${side}`).innerHTML = ''; document.getElementById(`hall-${side}`).innerHTML = '';
        });
        document.getElementById('monitor-opener').style.display = 'flex';
        closeCameraImmediate();
    }

    function updateTime() {
        if(!gameState.active) return;
        gameState.hour++;
        let disp = gameState.hour === 0 ? 12 : gameState.hour;
        document.getElementById('time-display').innerText = `${disp} AM`;
        if(gameState.hour === 6) winGame();
    }

    function updatePower() {
        if(!gameState.active) return;
        let usage = 1;
        if(gameState.doors.left) usage++; if(gameState.doors.right) usage++;
        if(gameState.lights.left) usage++; if(gameState.lights.right) usage++;
        if(gameState.cameraOpen) usage++;
        
        let displayUsage = Math.min(usage, 4);
        gameState.usage = usage; 
        updateUsageUI(displayUsage);
        
        gameState.power -= (usage*usage)/10;
        if(gameState.power <= 0) { gameState.power = 0; triggerPowerOutage(); }
        document.getElementById('power-display').innerText = `Power: ${Math.floor(gameState.power)}%`;
    }

    function updateAI() {
        if(!gameState.active) return;
        if(!goldenVrajActive && !gameState.cameraOpen && Math.random() < (0.001 * currentNight)) triggerGoldenVraj();
        animatronics.forEach(bot => { if(Math.random()*20 < bot.level) moveBot(bot); });
        if(gameState.lights.left) toggleLight('left', true); if(gameState.lights.right) toggleLight('right', true);
        renderCamera();
    }

    function triggerGoldenVraj() {
        goldenVrajActive = true; document.getElementById('golden-vraj').style.display = 'block';
        goldenTimer = setTimeout(() => { if(goldenVrajActive && gameState.active) triggerJumpscare({name: 'Golden Vraj'}); }, 3000);
    }

    function moveBot(bot) {
        if(bot.name === 'Foxy') { handleFoxy(bot); return; }
        if(bot.name === 'Freddy' && Math.random() > 0.5) playSound('laugh');
        if(bot.location === 'door_left') { if(!gameState.doors.left) triggerJumpscare(bot); else bot.location = '1A'; return; }
        if(bot.location === 'door_right') { if(!gameState.doors.right) triggerJumpscare(bot); else bot.location = '1A'; return; }
        let idx = bot.path.indexOf(bot.location);
        if(idx < bot.path.length - 1) {
            if(bot.name !== 'Freddy' && Math.random() > 0.7 && idx > 0) bot.location = bot.path[idx-1];
            else bot.location = bot.path[idx+1];
        }
    }

    function handleFoxy(foxy) {
        if(foxy.stage < 2) foxy.stage++;
        else if(foxy.stage === 2) {
            foxy.stage = 3; foxy.location = 'door_left'; playSound('run');
            setTimeout(() => {
                if(gameState.active && foxy.stage === 3) {
                     if(gameState.doors.left) { gameState.power -= 10; foxy.stage = 0; foxy.location = '1C'; playSound('bang'); }
                     else triggerJumpscare(foxy);
                }
            }, 2500);
        }
    }

    function toggleDoor(side) {
        if(!gameState.active || gameState.power <= 0) return;
        playSound('door');
        gameState.doors[side] = !gameState.doors[side];
        const shutter = document.getElementById(`shutter-${side}`);
        const btn = document.getElementById(`btn-door-${side}`);
        if(gameState.doors[side]) { shutter.classList.add('closed'); btn.classList.add('btn-active-door'); }
        else { shutter.classList.remove('closed'); btn.classList.remove('btn-active-door'); }
    }

    function toggleLight(side, on) {
        if(!gameState.active || gameState.power <= 0) return;
        gameState.lights[side] = on;
        if(on) {
            sounds.light.currentTime = 0; 
            sounds.light.play();
        } else {
            sounds.light.pause();
            sounds.light.currentTime = 0;
        }
        
        const win = document.getElementById(`window-${side}`);
        const door = document.getElementById(`doorway-${side}`);
        const hall = document.getElementById(`hall-${side}`);
        const btn = document.getElementById(`btn-light-${side}`);

        if(on) {
            win.style.backgroundColor = 'rgba(200, 220, 255, 0.3)';
            door.style.backgroundColor = 'rgba(200, 220, 255, 0.3)'; 
            btn.classList.add('btn-active-light');
            let bot = null;
            if(side==='left') bot = animatronics.find(a=>a.name==='Bonnie'&&a.location==='door_left') || animatronics.find(a=>a.name==='Foxy'&&a.stage===3);
            if(side==='right') bot = animatronics.find(a=>a.name==='Chica'&&a.location==='door_right') || animatronics.find(a=>a.name==='Freddy'&&a.location==='door_right');
            if(bot) {
                win.innerHTML = `<img src="textures/vrajs/shadow.png" class="shadow-img">`; 
                if(!gameState.doors[side]) hall.innerHTML = `<img src="textures/vrajs/${bot.name}_office.png" class="animatronic-full">`; 
                else hall.innerHTML = '';
            } else { win.innerHTML = ''; hall.innerHTML = ''; }
        } else {
            win.style.backgroundColor = 'transparent'; door.style.backgroundColor = '#050505';
            win.innerHTML = ''; hall.innerHTML = ''; btn.classList.remove('btn-active-light');
        }
    }

    function toggleMonitor() {
        if (!gameState.active || gameState.power <= 0) return;
        let now = Date.now();
        if (now - lastToggleTime < 250) return; 
        lastToggleTime = now;

        const p = document.getElementById('monitor-panel');
        const trig = document.getElementById('monitor-opener');
        const sys = document.getElementById('camera-system');

        if (!gameState.cameraOpen) {
            sounds.monitorUp.currentTime = 0;
            sounds.monitorUp.play();
            sounds.fan.volume = 0.02; // Muffle Fan
            
            if(goldenVrajActive) { goldenVrajActive = false; clearTimeout(goldenTimer); document.getElementById('golden-vraj').style.display='none'; }
            p.style.transform = "translateY(0%)";
            setTimeout(() => {
                gameState.cameraOpen = true; sys.style.display = 'block'; trig.style.display = 'none';
                p.style.transition = 'none'; p.style.transform = "translateY(100%)";
                void p.offsetWidth; p.style.transition = "transform 0.1s linear";
                renderCamera();
            }, 150);
        } else {
            sounds.monitorDown.currentTime = 0;
            sounds.monitorDown.play();
            sounds.fan.volume = 0.05; // Unmuffle Fan
            
            p.style.transition = 'none'; p.style.transform = "translateY(0%)";
            void p.offsetWidth; p.style.transition = "transform 0.1s linear";
            sys.style.display = 'none'; gameState.cameraOpen = false;
            requestAnimationFrame(() => p.style.transform = "translateY(100%)");
            setTimeout(() => trig.style.display = 'flex', 150);
        }
    }

    function closeCameraImmediate() {
        gameState.cameraOpen = false;
        sounds.fan.volume = 0.05;
        document.getElementById('camera-system').style.display = 'none';
        document.getElementById('monitor-opener').style.display = 'flex';
        document.getElementById('monitor-panel').style.transform = "translateY(100%)";
    }

    function switchCam(cam) {
        if(gameState.currentCam === cam) return;
        playSound('blip');
        gameState.currentCam = cam;
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('cam-selected'));
        document.getElementById(`btn-${cam}`).classList.add('cam-selected');
        
        renderCamera();
    }

    function renderCamera() {
        if(!gameState.cameraOpen) return;
        const c = document.getElementById('cam-content');
        document.getElementById('cam-label').innerText = `CAM ${gameState.currentCam}`;
        const feed = document.getElementById('cam-feed');
        
        let bg = `textures/cam${gameState.currentCam.toLowerCase()}.png`;
        if(gameState.currentCam === '6') { c.innerHTML = '<div style="font-size:30px;color:#555;">-CAMERA DISABLED-<br><br>AUDIO ONLY</div>'; feed.style.backgroundImage = 'none'; return; }
        feed.style.backgroundImage = `url('${bg}')`;
        c.innerHTML = '';

        animatronics.forEach(bot => {
            if(bot.location === gameState.currentCam) {
                // Specific Positioning for Stage 1A
                if (gameState.currentCam === '1A') {
                    let style = '';
                    if (bot.name === 'Bonnie') style = 'left: 10%; bottom: 0; width: auto; height: 90%;';
                    if (bot.name === 'Chica') style = 'right: 10%; bottom: 0; width: auto; height: 90%;';
                    if (bot.name === 'Freddy') style = 'left: 50%; transform: translateX(-50%); bottom: 0; width: auto; height: 95%; z-index: 2;';
                    c.innerHTML += `<img src="textures/vrajs/${bot.name}_${gameState.currentCam}.png" style="position: absolute; object-fit: contain; ${style}">`;
                } else if(bot.name !== 'Foxy') {
                    // Default for other cams
                    c.innerHTML += `<img src="textures/vrajs/${bot.name}_${gameState.currentCam}.png" style="width:100%; height:100%; object-fit:cover;">`;
                }
            }
        });
        
        if(gameState.currentCam==='1C') {
            let f = animatronics.find(a=>a.name==='Foxy');
            if(f) {
                c.innerHTML=`<img src="textures/vrajs/Foxy_1C_${f.stage}.png" style="width:100%; height:100%; object-fit:cover;">`;
            }
        }
        
        if(gameState.currentCam==='2A') {
             let f = animatronics.find(a=>a.name==='Foxy');
             if(f && f.stage === 3 && f.location === '2A') {
                 c.innerHTML=`<img src="textures/vrajs/Foxy_2A.png" style="width:100%; height:100%; object-fit:cover;">`;
             }
        }
    }

    let currentScroll = 0; const MAX_SCROLL = 20;
    document.addEventListener('mousemove', (e) => mouseX = e.clientX);

    function scrollLoop() {
        if(gameState.active && !gameState.cameraOpen) {
            const w = window.innerWidth;
            const t = w * 0.35;
            if(mouseX < t) currentScroll -= ((t-mouseX)/t)*1.5;
            else if(mouseX > w-t) currentScroll += ((mouseX-(w-t))/t)*1.5;
            if(currentScroll<0)currentScroll=0; if(currentScroll>MAX_SCROLL)currentScroll=MAX_SCROLL;
            document.getElementById('office').style.transform = `translateX(-${currentScroll}vw)`;
        }
        requestAnimationFrame(scrollLoop);
    }

    function triggerPowerOutage() {
        gameState.active = false;
        playSound('power'); sounds.fan.pause();
        closeCameraImmediate(); document.getElementById('office').style.background = '#000';
        document.getElementById('office').style.backgroundImage = 'none';
        document.getElementById('monitor-opener').style.display = 'none';
        ['left','right'].forEach(s => {
            document.getElementById(`shutter-${s}`).classList.remove('closed');
            document.getElementById(`window-${s}`).style.backgroundColor = 'transparent';
            document.getElementById(`doorway-${s}`).style.backgroundColor = '#050505';
        });
        setTimeout(() => triggerJumpscare({name:'Freddy'}), 5000);
    }

    function triggerJumpscare(bot) {
        if(!gameState.active && bot.name!=='Freddy') return;
        gameState.active = false;
        sounds.fan.pause(); 
        playSound('jump'); 
        
        clearInterval(timerHour); clearInterval(timerPower); clearInterval(timerAI);
        closeCameraImmediate(); document.getElementById('monitor-opener').style.display='none';
        
        const s = document.getElementById('game-over-screen'); s.style.display = 'flex';
        let tex = `textures/vrajs/${bot.name}_Jumpscare.png`;
        document.getElementById('jumpscare-anim').innerHTML = `<img src="${tex}" style="width:100%; height:100%; object-fit:contain;">`;
        
        // Wait for jump to finish (5s) then static then reload
        setTimeout(() => {
            const dStatic = document.getElementById('transition-static-death');
            dStatic.style.display = 'block';
            sounds.static.play();
            setTimeout(() => location.reload(), 2000);
        }, 5000);
    }

    // --- VIDEO INTERMISSION LOGIC ---
    function winGame() {
        gameState.active = false;
        sounds.fan.pause(); 
        
        // Progress Night
        if(!isCustomNight && currentNight < 6) localStorage.setItem('vraj_night', currentNight+1);
        
        clearInterval(timerHour); clearInterval(timerPower); clearInterval(timerAI);
        closeCameraImmediate(); document.getElementById('monitor-opener').style.display='none';
        
        document.getElementById('win-screen').classList.remove('hidden');
        document.getElementById('win-clock').innerText = "5 AM";
        
        // Transition Sequence
        setTimeout(() => {
            document.getElementById('win-clock').innerText = "6 AM";
            playSound('win');
            
            // Wait 17 seconds
            setTimeout(() => {
                const winScreen = document.getElementById('win-screen');
                const vidScreen = document.getElementById('video-screen');
                const vid = document.getElementById('intermission-video');
                
                // Static Transition
                triggerTransitionStatic(() => {
                    winScreen.classList.add('hidden');
                    vidScreen.style.display = 'flex';
                    
                    // Setup Video
                    let vidSrc = `videos/video${currentNight}.mp4`;
                    if(isCustomNight) vidSrc = 'videos/video7.mp4'; 
                    
                    vid.src = vidSrc;
                    vid.play().catch(e => {
                        console.log("Video failed, skipping");
                        location.reload();
                    });
                    
                    // On End
                    vid.onended = () => {
                        triggerTransitionStatic(() => {
                            location.reload();
                        });
                    };
                });
            }, 17000); // 17 seconds
        }, 2000);
    }

    function updateUsageUI(lvl) {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`bar${i}`);
            if(i<=lvl) b.classList.add('usage-active'); else b.classList.remove('usage-active');
        }
    }
</script>
</body>
</html>