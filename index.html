<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FIVE NIGHTS IN VRAJ</title>
<style>
    /* --- CSS RESET & BASICS --- */
    * {
        /* Force uniform blocky terminal font for all text */
        font-family: 'Courier New', Courier, monospace !important;
    }

    body {
        margin: 0; padding: 0;
        background-color: #000; color: #fff;
        overflow: hidden; user-select: none;
        height: 100vh; width: 100vw;
    }
    img { pointer-events: none; user-drag: none; -webkit-user-drag: none; }
    .hidden { display: none !important; }
    .flex-center { display: flex; justify-content: center; align-items: center; }
    
    /* GLOBAL EFFECTS */
    .scanlines {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 2px, 3px 100%;
        pointer-events: none; z-index: 999; opacity: 0.6;
    }
    .vignette {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.8) 100%);
        pointer-events: none; z-index: 900;
    }

    /* --- LOADING SCREEN --- */
    #loading-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    #loading-text { font-size: 3rem; margin-bottom: 20px; font-weight: bold; }
    #loading-bar-container { width: 50%; height: 20px; border: 2px solid #fff; padding: 2px; }
    #loading-bar { width: 0%; height: 100%; background: #fff; transition: width 0.1s; }

    /* --- MENUS --- */
    #menu-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 1000; display: none;
        overflow: hidden;
    }

    /* Base Static Layer */
    .static-anim {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-size: cover; pointer-events: none; z-index: 10;
        animation: staticCycle 0.2s infinite;
    }
    /* Static Overlay Layer for 9 & 10 (Now reduced frequency) */
    .static-anim::after {
        content: "";
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-size: cover; pointer-events: none;
        opacity: 0.5;
        animation: extraStaticCycle 1.5s infinite;
    }
    
    .static-opaque { opacity: 1; }
    .static-transparent { opacity: 0.3; } 
    .static-cam { opacity: 1; } 

    @keyframes staticCycle {
        0%, 12% { background-image: url('textures/static1.png'); }
        13%, 24% { background-image: url('textures/static2.png'); }
        25%, 37% { background-image: url('textures/static3.png'); }
        38%, 49% { background-image: url('textures/static4.png'); }
        50%, 62% { background-image: url('textures/static5.png'); }
        63%, 74% { background-image: url('textures/static6.png'); }
        75%, 87% { background-image: url('textures/static7.png'); }
        88%, 100% { background-image: url('textures/static8.png'); }
    }
    @keyframes extraStaticCycle {
        0%, 85% { background-image: none; }
        86%, 92% { background-image: url('textures/static9.png'); }
        93%, 100% { background-image: url('textures/static10.png'); }
    }

    .menu-left {
        width: 40%; height: 100%; display: flex; flex-direction: column;
        justify-content: center; padding-left: 50px; z-index: 1002;
    }
    .menu-title {
        font-size: 4rem; color: #fff; font-weight: bold;
        text-shadow: 0 0 10px #fff; margin-bottom: 20px;
        border-left: 5px solid #a00; padding-left: 20px;
    }
    .menu-stars {
        display: flex; gap: 10px; margin-bottom: 20px; padding-left: 20px;
    }
    .star { font-size: 2rem; color: gold; text-shadow: 0 0 5px #ffaa00; display: none; }
    
    .menu-options { display: flex; flex-direction: column; gap: 15px; align-items: flex-start; }
    button.menu-btn {
        background: transparent; border: none; color: #ccc;
        font-size: 2rem; font-weight: bold;
        text-align: left; cursor: pointer; transition: 0.1s;
        text-shadow: 2px 2px 0 #000;
    }
    button.menu-btn:hover { color: #fff; transform: translateX(10px); }
    
    .menu-night-display { 
        font-size: 1.2rem; color: #666; margin-top: 10px; 
        transition: 0.1s; font-weight: bold;
    }
    
    .menu-right { width: 60%; height: 100%; position: relative; overflow: hidden; z-index: 1; }
    #menu-animatronic {
        position: absolute; top: 10%; right: 0; width: 90%; height: 90%;
        object-fit: contain; opacity: 0.8; 
    }

    #reset-progress-btn {
        position: absolute; bottom: 10px; left: 10px;
        background: transparent; border: none; color: #fff;
        font-size: 10px; font-weight: bold;
        opacity: 0.5; cursor: pointer; z-index: 2000; text-transform: uppercase;
    }
    #reset-progress-btn:hover { opacity: 1; }

    /* CUSTOM NIGHT MENU */
    #custom-night-menu {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 1100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    #custom-night-menu .cn-content { z-index: 2; display: flex; flex-direction: column; align-items: center; width: 100%; }
    
    .cn-grid { 
        display: flex; gap: 40px; margin-bottom: 40px; 
        flex-wrap: nowrap; justify-content: center; width: 100%; 
    }
    .cn-char { text-align: center; font-weight: bold; width: 180px; }
    .cn-img { 
        width: 160px; height: 160px; object-fit: contain; 
        border: 4px solid #555; margin-bottom: 15px; background: #111; 
    }
    
    /* Remove arrows from number inputs and center text */
    .cn-input::-webkit-outer-spin-button,
    .cn-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .cn-input {
        background: #000; color: #fff; font-size: 3.5rem; width: 100px; 
        text-align: center; border: 4px solid #555; font-weight: bold;
        -moz-appearance: textfield; padding: 5px;
    }
    
    .cn-controls { display: flex; gap: 30px; margin-top: 30px; }
    .cn-btn { font-size: 2rem; padding: 15px 50px; cursor: pointer; border: 2px solid #fff; background: #000; color: #fff; font-weight: bold; }
    .cn-btn:hover { background: #fff; color: #000; }

    /* CONFETTI */
    .confetti {
        position: absolute; width: 10px; height: 10px; 
        animation: fall linear forwards; z-index: 2002;
        top: -10px;
    }
    @keyframes fall { to { transform: translateY(105vh) rotate(720deg); } }

    /* GAME UI */
    #win-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .clock-box { font-size: 6rem; font-weight: bold; border: 4px solid #fff; padding: 20px; margin-bottom: 20px; z-index: 2001; background: #000; }

    #game-over-screen {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: transparent; z-index: 9999; display: none;
        justify-content: center; align-items: center; overflow: hidden;
    }
    
    /* NEW VIOLENT JUMPSCARE ANIMATION */
    #jumpscare-anim {
        width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;
        /* Instant 50ms lunge, then chaotic 50ms looping shake */
        animation: lungeIn 0.05s ease-out forwards, crazyShake 0.05s 0.05s infinite;
        z-index: 9998;
    }
    #jumpscare-anim img {
        width: 100%; height: 100%; object-fit: contain;
        image-rendering: high-quality;
        filter: drop-shadow(0 0 50px rgba(0,0,0,1));
    }
    @keyframes lungeIn {
        0% { transform: scale(0.1) translateY(100px); opacity: 0; }
        100% { transform: scale(2.5) translateY(0); opacity: 1; }
    }
    @keyframes crazyShake {
        0% { transform: scale(2.5) translate(-40px, 30px) rotate(-4deg); filter: contrast(1.4) brightness(1.2); }
        25% { transform: scale(2.6) translate(40px, -30px) rotate(4deg); filter: contrast(1.1) brightness(0.9); }
        50% { transform: scale(2.4) translate(-20px, -40px) rotate(3deg); filter: contrast(1.5) brightness(1.3); }
        75% { transform: scale(2.7) translate(30px, 40px) rotate(-3deg); filter: contrast(1.0) brightness(1.0); }
        100% { transform: scale(2.5) translate(-40px, 30px) rotate(-4deg); filter: contrast(1.4) brightness(1.2); }
    }

    #help-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000 url('textures/help.png') no-repeat center center;
        background-size: contain; z-index: 3000; opacity: 0; display: none; pointer-events: none;
        transition: opacity 2s ease-in-out;
    }

    #video-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 4000; display: none;
        justify-content: center; align-items: center;
    }
    #intermission-video { width: 100%; height: 100%; object-fit: cover; }

    #ui-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 300; 
    }
    .hud-text { position: absolute; font-size: 1.5rem; font-weight: bold; text-shadow: 1px 1px 0 #000; }
    #time-display { top: 20px; right: 30px; }
    #night-display { top: 50px; right: 30px; font-size: 1rem; }
    #power-display { bottom: 55px; left: 30px; }
    #usage-label { position: absolute; bottom: 25px; left: 30px; font-weight: bold; font-size: 1.2rem; }
    #usage-box { position: absolute; bottom: 28px; left: 110px; display: flex; gap: 4px; }
    .usage-bar { width: 15px; height: 20px; background: #222; border: 1px solid #555; }
    .usage-active { background: #0f0; box-shadow: 0 0 5px #0f0; }

    /* --- OFFICE --- */
    #office {
        width: 120vw; height: 100vh; 
        background: url('textures/office.png') no-repeat center center;
        background-size: cover; background-color: #1a1a1a;
        position: absolute; top: 0; left: 0;
    }
    .wall-section {
        position: absolute; top: 0; height: 100%; width: 18%; background: transparent;
        z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center;
        pointer-events: none; 
    }
    #wall-left { left: 0; } #wall-right { right: 0; }

    .control-panel {
        width: 80px; height: 160px; 
        background: linear-gradient(to right, #999, #eee, #999); 
        border: 4px solid #444; border-radius: 8px;
        display: flex; flex-direction: column; justify-content: space-around; align-items: center;
        box-shadow: 10px 10px 30px #000, inset 0 0 15px #000; 
        transform: perspective(500px) rotateY(5deg); pointer-events: auto;
    }
    .ctrl-btn {
        width: 55px; height: 55px; 
        border-radius: 5px; cursor: pointer;
        border: 3px solid #666; font-size: 11px; font-weight: bold;
        display: flex; justify-content: center; align-items: center; color: #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.8), inset 0 2px 5px rgba(255,255,255,0.5);
        transition: transform 0.05s, box-shadow 0.05s;
    }
    .btn-door { background: radial-gradient(circle, #e00, #800); border-color: #600; border-radius: 50%; }
    .btn-light { background: radial-gradient(circle, #fff, #bbb); color: #000; border-color: #888; border-radius: 4px; } 
    
    .btn-active-door { 
        background: radial-gradient(circle, #800, #400); 
        box-shadow: inset 0 6px 12px #000; 
        border-color: #f00; transform: translateY(4px); 
    }
    .btn-active-light { 
        background: radial-gradient(circle, #ddf, #88f); 
        box-shadow: 0 0 20px #fff, inset 0 6px 12px rgba(0,0,0,0.6); 
        border-color: #fff; transform: translateY(4px); 
    }

    /* UPGRADED WINDOW STYLES */
    .window-frame {
        width: 80%; height: 25%; margin-bottom: 20px;
        position: relative; overflow: hidden; pointer-events: auto;
        
        background: #050505; border: 8px solid #222; border-bottom: 12px solid #111; 
        border-radius: 4px; box-sizing: border-box;
        box-shadow: inset 0 0 20px #000, 5px 5px 15px rgba(0,0,0,0.8);
    }
    .window-glass {
        width: 100%; height: 100%; position: relative; 
        display: flex; justify-content: center; align-items: center;
        transition: background-color 0.1s ease-in-out;
        
        background-color: transparent;
        background-image: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 30%, rgba(255,255,255,0.02) 70%, rgba(255,255,255,0.1) 100%);
    }
    .window-glass::after {
        content: ""; position: absolute; top: 0; left: 50%; width: 8px; height: 100%;
        background: linear-gradient(90deg, #111, #333, #111);
        transform: translateX(-50%); z-index: 5;
        box-shadow: 2px 0 5px rgba(0,0,0,0.8), -2px 0 5px rgba(0,0,0,0.8);
    }
    .shadow-img { width: 90%; height: 90%; object-fit: contain; filter: brightness(0); opacity: 0.95; }

    /* UPGRADED DOORWAY STYLES */
    .doorway {
        position: absolute; top: 15%; height: 70%; width: 15%; z-index: 1;
        display: flex; justify-content: center; align-items: center;
        transition: background-color 0.1s ease-in-out;
        
        background: #050505; 
        border: 10px solid #1a1a1a; border-bottom: none; border-radius: 10px 10px 0 0;
        box-shadow: inset 0 0 80px #000, 10px 0 20px rgba(0,0,0,0.9);
        box-sizing: border-box;
    }
    #doorway-left { left: 18%; } #doorway-right { right: 18%; }
    .animatronic-full { width: 100%; height: 100%; object-fit: contain; filter: brightness(0.7); }
    
    .door-shutter {
        position: absolute; top: 0; left: 0; width: 100%; height: 0%;
        background: url('textures/door.png'), repeating-linear-gradient(180deg, #333, #333 15px, #1a1a1a 15px, #1a1a1a 20px);
        background-size: cover; transition: height 0.2s linear; 
        border-bottom: 12px solid #444; z-index: 5; box-sizing: border-box;
        box-shadow: 0 10px 20px rgba(0,0,0,0.9);
    }
    .door-shutter.closed { height: 100%; }

    #monitor-panel {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 100%;
        background: #333; border: 20px solid #222; box-sizing: border-box;
        transform: translateY(100%); transition: transform 0.1s linear;
        z-index: 140; display: flex; justify-content: center; align-items: center; pointer-events: none;
    }
    #monitor-panel-inner { width: 90%; height: 90%; background: #111; border: 5px solid #555; }

    .trigger-bar {
        position: fixed; bottom: 0; left: 30%; width: 40%; height: 60px;
        z-index: 200; display: flex; justify-content: center; align-items: center;
        opacity: 0.3; transition: opacity 0.2s; cursor: pointer;
        border: 2px solid #555; background: rgba(255,255,255,0.05);
        border-top-left-radius: 10px; border-top-right-radius: 10px;
    }
    .trigger-bar:hover { opacity: 0.9; background: rgba(255,255,255,0.2); }
    .arrow-container { width: 100%; display: flex; justify-content: space-between; padding: 0 40px; }
    .trigger-arrow { color: #fff; font-size: 3rem; text-shadow: 2px 2px 0 #000; letter-spacing: -5px; font-weight: bold; }

    #golden-vraj {
        position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%); 
        width: 40%; height: 60%; object-fit: contain; z-index: 12; display: none;
        animation: twitch 0.1s infinite;
    }
    @keyframes twitch { 0% { transform: translate(-50%,0); } 50% { transform: translate(calc(-50% + 2px), -2px); } }

    #camera-system { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 150; display: none; }
    
    /* SCALED UP CAMERA MAP */
    #map-ui { 
        position: absolute; bottom: 80px; right: 30px; width: 320px; height: 260px; z-index: 200; 
        transform: scale(1.3); transform-origin: bottom right; 
    }
    #map-blueprint { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 190; pointer-events: none; opacity: 0.9; }
    .line-style { fill: none; stroke: #eee; stroke-width: 3px; }

    .cam-btn {
        position: absolute; background: rgba(40, 40, 40, 0.6); border: 2px solid #bbb; color: #fff;
        font-weight: bold; font-size: 13px; 
        display: flex; justify-content: center; align-items: center; text-align: center;
        cursor: pointer; z-index: 200; transition: background 0.1s; box-sizing: border-box; 
    }
    .cam-btn:hover { background: rgba(80, 80, 80, 0.7); }
    .cam-selected { background: #adff2f !important; color: #000 !important; border-color: #fff !important; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.7; } }

    #btn-1A { top: 10px; left: 110px; width: 70px; height: 40px; } 
    #btn-1B { top: 60px; left: 100px; width: 90px; height: 50px; } 
    #btn-5  { top: 25px; left: 30px;  width: 55px; height: 35px; } 
    #btn-1C { top: 85px; left: 30px;  width: 45px; height: 45px; } 
    #btn-7  { top: 25px; left: 205px; width: 60px; height: 35px; } 
    #btn-6  { top: 80px; left: 215px; width: 60px; height: 45px; } 
    #btn-2A { top: 130px; left: 95px; width: 40px; height: 50px; } 
    #btn-2B { top: 195px; left: 95px; width: 40px; height: 35px; } 
    #btn-3  { top: 155px; left: 40px; width: 40px; height: 35px; } 
    #btn-4A { top: 130px; left: 155px; width: 40px; height: 50px; } 
    #btn-4B { top: 195px; left: 155px; width: 40px; height: 35px; } 

    #cam-feed { width: 100%; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; background-size: cover; background-position: center; }
    #cam-label { position: absolute; top: 30px; left: 30px; font-size: 2rem; border-left: 5px solid red; padding-left: 10px; text-shadow: 2px 2px #000; font-weight: bold;}
    #cam-content { font-size: 8rem; position: relative; display:flex; justify-content:center; align-items:center; width: 100%; height: 100%; }
    
    #transition-static { display:none; z-index: 9999; }
    #cam-move-static { display:none; z-index: 160; position:absolute; top:0; left:0; width:100%; height:100%; }
</style>
</head>
<body oncontextmenu="return false;" ondragstart="return false;">

<div id="loading-screen">
    <div id="loading-text">LOADING...</div>
    <div id="loading-bar-container"><div id="loading-bar"></div></div>
</div>

<div class="scanlines"></div>
<div class="vignette"></div>

<div id="menu-screen">
    <div class="static-anim static-transparent" style="z-index: 0;"></div>
    <div class="menu-left">
        <div class="menu-title">FIVE NIGHTS<br>IN VRAJ</div>
        <div class="menu-stars" id="menu-stars">
            <span class="star" id="star1">★</span>
            <span class="star" id="star2">★</span>
            <span class="star" id="star3">★</span>
        </div>
        <div class="menu-options">
            <button class="menu-btn" onclick="startNewGame()">New Game</button>
            <button class="menu-btn" onclick="continueGame()">Continue</button>
            <div class="menu-night-display" id="menu-night-text">Night 1</div>
        </div>
    </div>
    <div class="menu-right"><img id="menu-animatronic" src="textures/menu1.png"></div>
    <button id="reset-progress-btn" onclick="resetProgress()">Reset Progress</button>
</div>

<div id="help-overlay"></div>

<div id="transition-static" class="static-anim static-opaque"></div>

<div id="custom-night-menu" class="hidden">
    <div class="static-anim static-transparent" style="z-index: 0;"></div>
    <div class="cn-content">
        <h1 style="font-size: 3rem; margin-bottom: 20px; font-weight: bold;">CUSTOM NIGHT</h1>
        <div class="cn-grid">
            <div class="cn-char">
                <img src="textures/vrajs/Bonnie_office.png" class="cn-img">
                <div style="margin-bottom:5px;">BONNIE</div>
                <input type="number" id="ai-bonnie" class="cn-input" min="0" max="20" value="0" onchange="capAI(this)">
            </div>
            <div class="cn-char">
                <img src="textures/vrajs/Chica_office.png" class="cn-img">
                <div style="margin-bottom:5px;">CHICA</div>
                <input type="number" id="ai-chica" class="cn-input" min="0" max="20" value="0" onchange="capAI(this)">
            </div>
            <div class="cn-char">
                <img src="textures/vrajs/Freddy_office.png" class="cn-img">
                <div style="margin-bottom:5px;">FREDDY</div>
                <input type="number" id="ai-freddy" class="cn-input" min="0" max="20" value="0" onchange="capAI(this)">
            </div>
            <div class="cn-char">
                <img src="textures/vrajs/Foxy_office.png" class="cn-img">
                <div style="margin-bottom:5px;">FOXY</div>
                <input type="number" id="ai-foxy" class="cn-input" min="0" max="20" value="0" onchange="capAI(this)">
            </div>
        </div>
        <div class="cn-controls">
            <button class="cn-btn" onclick="returnToMenu()">BACK</button>
            <button class="cn-btn" onclick="setAll20()">ALL 20</button>
            <button class="cn-btn" onclick="startCustomNight()">READY</button>
        </div>
    </div>
</div>

<div id="win-screen" class="hidden"><div class="clock-box" id="win-clock">5 AM</div><div style="font-size: 2rem; color: #888; font-weight: bold;">NIGHT COMPLETE</div></div>
<div id="game-over-screen">
    <div id="transition-static-death" class="static-anim static-opaque" style="z-index: 9999; display:none;"></div>
    <div id="jumpscare-anim" style="z-index: 2;"></div>
</div>

<div id="monitor-panel"><div id="monitor-panel-inner"></div></div>

<div id="video-screen">
    <video id="intermission-video" style="width:100%; height:100%; object-fit:cover;"></video>
</div>

<div id="office">
    <img id="golden-vraj" src="textures/vrajs/golden.png">
    <div class="wall-section" id="wall-left">
        <div class="window-frame"><div class="window-glass" id="window-left"></div></div>
        <div class="control-panel">
            <div class="ctrl-btn btn-door" id="btn-door-left" onclick="toggleDoor('left')">DOOR</div>
            <div class="ctrl-btn btn-light" id="btn-light-left" onmousedown="toggleLight('left', true)" onmouseup="toggleLight('left', false)" onmouseleave="toggleLight('left', false)">LIGHT</div>
        </div>
    </div>
    <div class="doorway" id="doorway-left"><div class="door-shutter" id="shutter-left"></div><div id="hall-left" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;"></div></div>

    <div class="wall-section" id="wall-right">
        <div class="window-frame"><div class="window-glass" id="window-right"></div></div>
        <div class="control-panel">
            <div class="ctrl-btn btn-door" id="btn-door-right" onclick="toggleDoor('right')">DOOR</div>
            <div class="ctrl-btn btn-light" id="btn-light-right" onmousedown="toggleLight('right', true)" onmouseup="toggleLight('right', false)" onmouseleave="toggleLight('right', false)">LIGHT</div>
        </div>
    </div>
    <div class="doorway" id="doorway-right"><div class="door-shutter" id="shutter-right"></div><div id="hall-right" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;"></div></div>
</div>

<div class="trigger-bar" id="monitor-opener" onmouseenter="toggleMonitor()"><div class="arrow-container"><div class="trigger-arrow">&gt;&gt;</div><div class="trigger-arrow">&lt;&lt;</div></div></div>

<div id="ui-layer">
    <div id="time-display" class="hud-text">12 AM</div><div id="night-display" class="hud-text">Night 1</div>
    <div id="power-display" class="hud-text">Power: 100%</div><div id="usage-label">Usage:</div>
    <div id="usage-box"><div class="usage-bar" id="bar1"></div><div class="usage-bar" id="bar2"></div><div class="usage-bar" id="bar3"></div><div class="usage-bar" id="bar4"></div></div>
</div>

<div id="camera-system">
    <div class="static-anim static-transparent"></div>
    <div id="cam-move-static" class="static-anim static-cam"></div>
    
    <div id="cam-feed"><div id="cam-label">CAM 1A</div><div id="cam-content"></div></div>
    
    <div id="map-ui">
        <svg id="map-blueprint">
            <line class="line-style" x1="145" y1="50" x2="145" y2="60" />
            <line class="line-style" x1="85" y1="40" x2="100" y2="70" />
            <line class="line-style" x1="205" y1="40" x2="190" y2="70" />
            <line class="line-style" x1="75" y1="100" x2="100" y2="90" />
            <line class="line-style" x1="215" y1="100" x2="190" y2="90" />
            <line class="line-style" x1="115" y1="110" x2="115" y2="130" />
            <line class="line-style" x1="175" y1="110" x2="175" y2="130" />
            <line class="line-style" x1="115" y1="180" x2="115" y2="195" />
            <line class="line-style" x1="175" y1="180" x2="175" y2="195" />
            <line class="line-style" x1="80" y1="170" x2="95" y2="155" />
        </svg>

        <div class="cam-btn cam-selected" id="btn-1A" onclick="switchCam('1A')">CAM 1A</div>
        <div class="cam-btn" id="btn-1B" onclick="switchCam('1B')">CAM 1B</div>
        <div class="cam-btn" id="btn-5" onclick="switchCam('5')">CAM 5</div>
        <div class="cam-btn" id="btn-1C" onclick="switchCam('1C')">CAM 1C</div>
        <div class="cam-btn" id="btn-7" onclick="switchCam('7')">CAM 7</div>
        <div class="cam-btn" id="btn-6" onclick="switchCam('6')">CAM 6</div>
        <div class="cam-btn" id="btn-2A" onclick="switchCam('2A')">CAM 2A</div>
        <div class="cam-btn" id="btn-3" onclick="switchCam('3')">CAM 3</div>
        <div class="cam-btn" id="btn-2B" onclick="switchCam('2B')">CAM 2B</div>
        <div class="cam-btn" id="btn-4A" onclick="switchCam('4A')">CAM 4A</div>
        <div class="cam-btn" id="btn-4B" onclick="switchCam('4B')">CAM 4B</div>
    </div>
    
    <div class="trigger-bar" style="z-index: 300;" onmouseenter="toggleMonitor()"><div class="arrow-container"><div class="trigger-arrow">&gt;&gt;</div><div class="trigger-arrow">&lt;&lt;</div></div></div>
</div>

<script>
    const GAME_HOUR_DURATION = 80000; // 80 seconds per hour (8 mins total)
    const AI_MOVE_INTERVAL = 4970; // 4.97 seconds
    const JUMPSCARE_DURATION = 5000; 
    
    const imageList = [
        'textures/office.png', 'textures/door.png', 'textures/help.png', 
        'textures/menu1.png', 'textures/menu2.png',
        'textures/static1.png', 'textures/static2.png', 'textures/static3.png',
        'textures/static4.png', 'textures/static5.png', 'textures/static6.png',
        'textures/static7.png', 'textures/static8.png', 'textures/static9.png', 'textures/static10.png',
        'textures/cam1a.png', 'textures/cam1b.png', 'textures/cam1c.png', 'textures/cam2a.png', 
        'textures/cam2b.png', 'textures/cam3.png', 'textures/cam4a.png', 'textures/cam4b.png', 
        'textures/cam5.png', 'textures/cam7.png',
        'textures/cam1c2.png', 'textures/cam1c3.png', 'textures/cam1c4.png',
        'textures/vrajs/Bonnie_1A.png', 'textures/vrajs/Bonnie_1B.png', 'textures/vrajs/Bonnie_5.png', 'textures/vrajs/Bonnie_2A.png', 'textures/vrajs/Bonnie_2B.png', 'textures/vrajs/Bonnie_3.png', 'textures/vrajs/Bonnie_office.png',
        'textures/vrajs/Chica_1A.png', 'textures/vrajs/Chica_1B.png', 'textures/vrajs/Chica_7.png', 'textures/vrajs/Chica_4A.png', 'textures/vrajs/Chica_4B.png', 'textures/vrajs/Chica_office.png',
        'textures/vrajs/Freddy_1A.png', 'textures/vrajs/Freddy_1B.png', 'textures/vrajs/Freddy_7.png', 'textures/vrajs/Freddy_4A.png', 'textures/vrajs/Freddy_4B.png', 'textures/vrajs/Freddy_office.png',
        'textures/vrajs/Foxy_2A.png', 'textures/vrajs/Foxy_office.png',
        'textures/vrajs/Freddy_Jumpscare.png', 'textures/vrajs/Bonnie_Jumpscare.png', 'textures/vrajs/Chica_Jumpscare.png', 'textures/vrajs/Foxy_Jumpscare.png', 'textures/vrajs/golden_jumpscare.png',
        'textures/vrajs/golden.png'
    ];

    const sounds = {
        fan: new Audio('sounds/fan.mp3'),
        door: new Audio('sounds/door.mp3'),
        light: new Audio('sounds/light.mp3'),
        monitorUp: new Audio('sounds/monitor_up.mp3'),
        monitorDown: new Audio('sounds/monitor_down.mp3'),
        blip: new Audio('sounds/blip.mp3'),
        static: new Audio('sounds/static.mp3'),
        laugh: new Audio('sounds/laugh.mp3'),
        run: new Audio('sounds/run.mp3'),
        bang: new Audio('sounds/bang.mp3'),
        power: new Audio('sounds/power_out.mp3'),
        jump: new Audio('sounds/jumpscare.mp3'),
        win: new Audio('sounds/6am.mp3'),
        menuMusic: new Audio('sounds/menu_music.mp3'),
        surprise: new Audio('sounds/suprise.mp3') // NEW SURPRISE SOUND
    };
    
    sounds.fan.loop = true; sounds.fan.volume = 0.05; sounds.fan.preload = 'auto';
    sounds.static.loop = true; sounds.static.volume = 0.3; sounds.static.preload = 'auto';
    sounds.light.loop = true; sounds.light.preload = 'auto';
    sounds.menuMusic.loop = true; sounds.menuMusic.preload = 'auto';
    if(sounds.surprise) sounds.surprise.preload = 'auto';

    let assetsLoaded = 0;
    const totalAssets = imageList.length;

    function preloadAssets() {
        if(totalAssets === 0) { showMenu(); return; }
        imageList.forEach(path => {
            const img = new Image();
            img.src = path;
            img.onload = () => { assetsLoaded++; updateLoadingBar(); };
            img.onerror = () => { console.log("Missing: " + path); assetsLoaded++; updateLoadingBar(); };
        });
    }

    function updateLoadingBar() {
        const pct = (assetsLoaded / totalAssets) * 100;
        document.getElementById('loading-bar').style.width = pct + '%';
        if(assetsLoaded >= totalAssets) setTimeout(showMenu, 500);
    }

    function showMenu() {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('menu-screen').style.display = 'flex';
        checkStars();
        
        let displayNight = currentNight;
        document.getElementById('menu-night-text').innerText = `Night ${displayNight}`;
    }

    function resetProgress() {
        if (confirm("Are you sure you want to reset all progress?")) {
            localStorage.clear();
            location.reload();
        }
    }

    preloadAssets();

    let currentNight = parseInt(localStorage.getItem('vraj_night')) || 1;
    let lastToggleTime = 0; let mouseX = 0; let isCustomNight = false;
    let goldenVrajActive = false; let goldenTimer = null;
    let foxyRunPending = false;
    let powerTimer = null;
    
    // Surprise sound logic trackers
    let seenAtDoor = { left: false, right: false };

    const NIGHT_DIFFICULTY = { 1: [0,0,0,0,0], 2: [3,1,0,1,0], 3: [0,5,2,2,0], 4: [2,4,6,6,0], 5: [5,7,5,10,0], 6: [10,12,6,16,0] };
    let gameState = { active: false, hour: 0, power: 100, usage: 1, cameraOpen: false, currentCam: '1A', doors: {left:false,right:false}, lights: {left:false,right:false} };
    
    // Adjacency Map for Realistic Movement
    const ADJACENCY = {
        'Bonnie': { '1A':['1B'], '1B':['5','2A'], '5':['1B'], '2A':['3','2B'], '3':['2A'], '2B':['door_left'] },
        'Chica': { '1A':['1B'], '1B':['7','4A'], '7':['1B'], '4A':['6','4B'], '6':['4A'], '4B':['door_right'] },
        'Freddy': { '1A':['1B'], '1B':['7'], '7':['6'], '6':['4A'], '4A':['4B'], '4B':['door_right'] } 
    };

    let animatronics = [
        { name: 'Bonnie', location: '1A', level: 0 },
        { name: 'Chica',  location: '1A', level: 0 },
        { name: 'Freddy', location: '1A', level: 0 },
        { name: 'Foxy',   location: '1C', level: 0, stage: 0, patience: 100 },
        { name: 'Golden Vraj', location: null, level: 0 } 
    ];
    let timerHour, timerAI, timerMenuAnim;

    function playSound(name) { if(sounds[name]) { sounds[name].currentTime = 0; sounds[name].play().catch(()=>{}); } }

    function checkStars() {
        if(localStorage.getItem('vraj_star1')) document.getElementById('star1').style.display = 'inline';
        if(localStorage.getItem('vraj_star2')) document.getElementById('star2').style.display = 'inline';
        if(localStorage.getItem('vraj_star3')) document.getElementById('star3').style.display = 'inline';
    }

    function capAI(input) {
        if(input.value > 20) input.value = 20;
        if(input.value < 0) input.value = 0;
    }

    // DEBUG CHEATS & HOTKEYS
    document.addEventListener('keydown', (e) => {
        if(e.ctrlKey && e.shiftKey && e.code === 'KeyO') {
            localStorage.setItem('vraj_night', 7);
            location.reload();
        }
        if(e.code === 'KeyP' && gameState.active) {
            winGame(); // Skip to win
        }
        if(e.code === 'KeyL' && gameState.active) {
            // Random Jumpscare for testing
            let availableBots = animatronics.filter(a => a.name !== 'Golden Vraj');
            let randomBot = availableBots[Math.floor(Math.random() * availableBots.length)];
            triggerJumpscare(randomBot);
        }
    });

    document.body.addEventListener('click', () => {
        if(document.getElementById('menu-screen').style.display !== 'none') {
            sounds.menuMusic.play().catch(()=>{});
        }
    }, {once:true});

    // MENU TWITCH ANIMATION
    timerMenuAnim = setInterval(() => {
        const img = document.getElementById('menu-animatronic');
        if(Math.random() > 0.7) {
            img.src = 'textures/menu2.png';
            setTimeout(() => { img.src = 'textures/menu1.png'; }, 80);
        }
    }, 800);

    function triggerTransitionStatic(callback) {
        const s = document.getElementById('transition-static');
        s.style.display = 'block';
        sounds.static.currentTime = 0; sounds.static.play();
        setTimeout(() => {
            s.style.display = 'none';
            sounds.static.pause();
            if(callback) callback();
        }, 250);
    }

    function triggerCamStatic(duration = 140) {
        if(gameState.cameraOpen) {
            const s = document.getElementById('cam-move-static');
            s.style.display = 'block';
            setTimeout(() => { s.style.display = 'none'; }, duration); 
        }
    }

    function startNewGame() { 
        triggerTransitionStatic(() => {
            currentNight = 1; localStorage.setItem('vraj_night', 1); isCustomNight = false; launchNight(); 
        });
    }
    
    function continueGame() { 
        if (currentNight >= 7) {
            openCustomNight();
            return;
        }
        if(currentNight > 5 && currentNight < 7) currentNight = 6; 
        isCustomNight = false; 
        triggerTransitionStatic(() => { launchNight(); });
    }
    
    function openCustomNight() { 
        document.getElementById('menu-screen').classList.add('hidden'); 
        document.getElementById('custom-night-menu').classList.remove('hidden'); 
    }
    
    function setAll20() {
        document.getElementById('ai-bonnie').value = 20;
        document.getElementById('ai-chica').value = 20;
        document.getElementById('ai-freddy').value = 20;
        document.getElementById('ai-foxy').value = 20;
    }

    function startCustomNight() {
        isCustomNight = true;
        let b = parseInt(document.getElementById('ai-bonnie').value)||0; 
        let c = parseInt(document.getElementById('ai-chica').value)||0;
        let f = parseInt(document.getElementById('ai-freddy').value)||0; 
        let x = parseInt(document.getElementById('ai-foxy').value)||0;
        
        NIGHT_DIFFICULTY[7] = [b,c,f,x,0]; 
        currentNight = 7;
        document.getElementById('custom-night-menu').classList.add('hidden'); 
        triggerTransitionStatic(() => { launchNight(); });
    }
    function returnToMenu() { location.reload(); }

    function launchNight() {
        sounds.menuMusic.pause(); sounds.menuMusic.currentTime = 0; 
        document.getElementById('menu-screen').classList.add('hidden'); 
        document.getElementById('win-screen').classList.add('hidden'); 
        document.getElementById('game-over-screen').style.display = 'none';
        
        let levels = NIGHT_DIFFICULTY[currentNight] || [20,20,20,20,20];
        animatronics.forEach((a, i) => a.level = levels[i]);
        
        resetGame();

        if (currentNight === 1 && !isCustomNight) {
            const help = document.getElementById('help-overlay');
            help.style.display = 'block'; help.style.opacity = 1;
            setTimeout(() => {
                help.style.opacity = 0;
                setTimeout(() => { help.style.display = 'none'; startGameLoop(); }, 2000);
            }, 5000);
        } else { startGameLoop(); }
    }

    function startGameLoop() {
        gameState.active = true;
        sounds.fan.play().catch(()=>{});
        timerHour = setInterval(updateTime, GAME_HOUR_DURATION); 
        timerAI = setInterval(updateAI, AI_MOVE_INTERVAL);
        startPowerDrain(); 
        requestAnimationFrame(scrollLoop); 
        renderCamera();
    }

    function resetGame() {
        gameState = { active: false, hour: 0, power: 100, usage: 1, cameraOpen: false, currentCam: '1A', doors: {left:false,right:false}, lights: {left:false,right:false} };
        animatronics.forEach(a => { if(a.name!=='Golden Vraj') a.location = '1A'; });
        let foxy = animatronics.find(a=>a.name==='Foxy'); foxy.location = '1C'; foxy.stage = 0; foxy.patience = 100;
        foxyRunPending = false;
        
        goldenVrajActive = false; clearTimeout(goldenTimer); document.getElementById('golden-vraj').style.display = 'none';
        seenAtDoor = { left: false, right: false }; // Reset sightings

        document.getElementById('night-display').innerText = isCustomNight ? "Custom Night" : `Night ${currentNight}`;
        document.getElementById('time-display').innerText = "12 AM"; document.getElementById('power-display').innerText = "Power: 100%";
        ['left', 'right'].forEach(side => {
            document.getElementById(`shutter-${side}`).classList.remove('closed');
            document.getElementById(`btn-door-${side}`).classList.remove('btn-active-door');
            document.getElementById(`btn-light-${side}`).classList.remove('btn-active-light');
            document.getElementById(`window-${side}`).style.backgroundColor = 'transparent';
            document.getElementById(`doorway-${side}`).style.backgroundColor = '#050505';
            document.getElementById(`window-${side}`).innerHTML = ''; document.getElementById(`hall-${side}`).innerHTML = '';
        });
        document.getElementById('monitor-opener').style.display = 'flex';
        closeCameraImmediate();
    }

    function updateTime() {
        if(!gameState.active) return;
        gameState.hour++;
        let disp = gameState.hour === 0 ? 12 : gameState.hour;
        document.getElementById('time-display').innerText = `${disp} AM`;
        
        if(!isCustomNight) {
            let b = animatronics[0]; let c = animatronics[1]; let f = animatronics[3]; 
            if(currentNight === 1) {
                if(gameState.hour === 2) b.level = 1;
                if(gameState.hour === 3) { b.level = 2; c.level = 1; f.level = 1; }
                if(gameState.hour === 4) { b.level = 3; c.level = 2; f.level = 2; }
            } else if(currentNight === 2) {
                if(gameState.hour === 3) { b.level+=1; c.level+=1; f.level+=1; }
            } else if(currentNight === 3) {
                if(gameState.hour === 3) { b.level+=1; c.level+=1; f.level+=1; }
            }
        }

        if(gameState.hour === 6) winGame();
    }

    function startPowerDrain() {
        clearInterval(powerTimer);
        let drainInterval = 9600; 
        
        let usage = 1;
        if(gameState.doors.left) usage++; if(gameState.doors.right) usage++;
        if(gameState.lights.left) usage++; if(gameState.lights.right) usage++;
        if(gameState.cameraOpen) usage++;
        
        if(usage === 2) drainInterval = 4800;
        if(usage === 3) drainInterval = 2500; // Significantly faster with 2 doors closed
        if(usage === 4) drainInterval = 1500;
        if(usage >= 5) drainInterval = 1000;

        let displayUsage = Math.min(usage, 4);
        gameState.usage = usage; 
        updateUsageUI(displayUsage);

        powerTimer = setInterval(() => {
            if(!gameState.active) return;
            gameState.power--;
            document.getElementById('power-display').innerText = `Power: ${gameState.power}%`;
            if(gameState.power <= 0) { 
                gameState.power = 0; 
                clearInterval(powerTimer); 
                triggerPowerOutage(); 
            }
        }, drainInterval);
    }

    function updateAI() {
        if(!gameState.active) return;
        updateFoxy();
        
        animatronics.forEach(bot => { 
            if(bot.name === 'Foxy' || bot.name === 'Golden Vraj') return; 
            if(Math.random()*20 < bot.level) moveBot(bot); 
        });
        if(gameState.lights.left) toggleLight('left', true); if(gameState.lights.right) toggleLight('right', true);
        renderCamera();
    }
    
    function updateFoxy() {
        let foxy = animatronics.find(a=>a.name==='Foxy');
        if(foxy.stage === 3 && foxyRunPending === false && !gameState.cameraOpen) {
        } else if (foxy.stage < 3) {
            if(gameState.cameraOpen && gameState.currentCam === '1C') foxy.patience = Math.min(foxy.patience + 5, 100); 
            else foxy.patience -= foxy.level;

            if(foxy.patience <= 0) {
                if(gameState.cameraOpen && gameState.currentCam === '1C') triggerCamStatic(400);
                foxy.stage++;
                foxy.patience = 100;
                if(foxy.stage === 3) foxy.location = '2A';
            }
        }
    }

    function checkGoldenVrajSpawn() {
        let chance = 0.001 * currentNight;
        if(isCustomNight) chance = 0.05; 
        if (!goldenVrajActive && Math.random() < chance) spawnGoldenVraj();
    }

    function spawnGoldenVraj() {
        goldenVrajActive = true;
        document.getElementById('golden-vraj').style.display = 'block';
        sounds.laugh.play(); 
        goldenTimer = setTimeout(() => {
            if (goldenVrajActive && gameState.active) {
                triggerJumpscare({ name: 'Golden Vraj' });
            }
        }, 1500);
    }

    function moveBot(bot) {
        if(bot.name === 'Freddy' && Math.random() > 0.5) playSound('laugh');
        
        let oldLoc = bot.location;
        
        // Attack/Door Logic
        if(bot.location === 'door_left') { 
            if(!gameState.doors.left) { triggerJumpscare(bot); return; }
            else { 
                bot.location = '1B'; 
                seenAtDoor.left = false; // Reset surprise sound
            }
        } else if(bot.location === 'door_right') { 
            if(!gameState.doors.right) { triggerJumpscare(bot); return; }
            else { 
                bot.location = '1B'; 
                seenAtDoor.right = false; // Reset surprise sound
            }
        } else {
            // Normal Movement
            let possibleMoves = ADJACENCY[bot.name][bot.location];
            if(possibleMoves) {
                let nextLoc = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                
                if(bot.name === 'Freddy') {
                   if(bot.location === '4A') nextLoc = '4B'; 
                   if(bot.location === '4B') {
                       if(gameState.cameraOpen && gameState.currentCam === '4B') return; 
                       else nextLoc = 'door_right';
                   }
                }

                if(gameState.cameraOpen && (gameState.currentCam === oldLoc || gameState.currentCam === nextLoc)) {
                    triggerCamStatic(400);
                }
                
                // Reset surprise sound if entering door state
                if (nextLoc === 'door_left') seenAtDoor.left = false;
                if (nextLoc === 'door_right') seenAtDoor.right = false;

                bot.location = nextLoc;
            }
        }
    }
    
    function handleFoxyRun() {
        let foxy = animatronics.find(a=>a.name==='Foxy');
        foxy.location = 'door_left'; 
        
        setTimeout(() => {
             if(gameState.active) {
                 if(gameState.doors.left) { 
                     gameState.power -= 5; playSound('bang'); 
                     document.getElementById('power-display').innerText = `Power: ${gameState.power}%`;
                     foxy.stage = Math.random() > 0.5 ? 0 : 1; 
                     foxy.location = '1C'; foxy.patience = 100;
                 } else { triggerJumpscare(foxy); }
                 foxyRunPending = false; 
             }
        }, 2000); 
    }

    function toggleDoor(side) {
        if(!gameState.active || gameState.power <= 0) return;
        playSound('door');
        gameState.doors[side] = !gameState.doors[side];
        const shutter = document.getElementById(`shutter-${side}`);
        const btn = document.getElementById(`btn-door-${side}`);
        if(gameState.doors[side]) { shutter.classList.add('closed'); btn.classList.add('btn-active-door'); }
        else { shutter.classList.remove('closed'); btn.classList.remove('btn-active-door'); }
        startPowerDrain();
    }

    function toggleLight(side, on) {
        if(!gameState.active || gameState.power <= 0) return;
        gameState.lights[side] = on;
        startPowerDrain(); 
        if(on) { sounds.light.currentTime = 0; sounds.light.play(); } 
        else { sounds.light.pause(); sounds.light.currentTime = 0; }
        
        const win = document.getElementById(`window-${side}`);
        const door = document.getElementById(`doorway-${side}`);
        const hall = document.getElementById(`hall-${side}`);
        const btn = document.getElementById(`btn-light-${side}`);

        if(on) {
            win.style.backgroundColor = 'rgba(200, 220, 255, 0.3)';
            door.style.backgroundColor = 'rgba(200, 220, 255, 0.3)'; 
            btn.classList.add('btn-active-light');
            let bot = null;
            if(side==='left') bot = animatronics.find(a=>a.name==='Bonnie'&&a.location==='door_left') || animatronics.find(a=>a.name==='Foxy'&&a.stage===3);
            if(side==='right') bot = animatronics.find(a=>a.name==='Chica'&&a.location==='door_right') || animatronics.find(a=>a.name==='Freddy'&&a.location==='door_right');
            
            if(bot) {
                // Trigger Surprise Sound if first time seeing them at door this encounter
                if(!seenAtDoor[side] && bot.name !== 'Foxy') {
                    playSound('surprise');
                    seenAtDoor[side] = true;
                }

                win.innerHTML = `<img src="textures/vrajs/${bot.name}_office.png" class="shadow-img">`; 
                if(!gameState.doors[side]) hall.innerHTML = `<img src="textures/vrajs/${bot.name}_office.png" class="animatronic-full">`; 
                else hall.innerHTML = '';
            } else { win.innerHTML = ''; hall.innerHTML = ''; }
        } else {
            win.style.backgroundColor = 'transparent'; door.style.backgroundColor = '#050505';
            win.innerHTML = ''; hall.innerHTML = ''; btn.classList.remove('btn-active-light');
        }
    }

    function toggleMonitor() {
        if (!gameState.active || gameState.power <= 0) return;
        let now = Date.now();
        if (now - lastToggleTime < 250) return; 
        lastToggleTime = now;

        const p = document.getElementById('monitor-panel');
        const trig = document.getElementById('monitor-opener');
        const sys = document.getElementById('camera-system');

        if (!gameState.cameraOpen) {
            sounds.monitorUp.currentTime = 0; sounds.monitorUp.play();
            sounds.fan.volume = 0.02; 
            if(goldenVrajActive) { goldenVrajActive = false; clearTimeout(goldenTimer); document.getElementById('golden-vraj').style.display='none'; }
            
            p.style.transform = "translateY(0%)";
            setTimeout(() => {
                gameState.cameraOpen = true; sys.style.display = 'block'; trig.style.display = 'none';
                p.style.transition = 'none'; p.style.transform = "translateY(100%)";
                void p.offsetWidth; p.style.transition = "transform 0.1s linear";
                renderCamera();
                startPowerDrain();
            }, 150);
        } else {
            sounds.monitorDown.currentTime = 0; sounds.monitorDown.play();
            sounds.fan.volume = 0.05; 
            
            // Foxy run check on closing monitor
            let foxy = animatronics.find(a=>a.name==='Foxy');
            if(foxy.stage === 3 && !foxyRunPending) { 
                foxyRunPending = true; playSound('run'); handleFoxyRun(); 
            }

            p.style.transition = 'none'; p.style.transform = "translateY(0%)";
            void p.offsetWidth; p.style.transition = "transform 0.1s linear";
            sys.style.display = 'none'; gameState.cameraOpen = false;
            requestAnimationFrame(() => p.style.transform = "translateY(100%)");
            setTimeout(() => { trig.style.display = 'flex'; checkGoldenVrajSpawn(); startPowerDrain(); }, 150);
        }
    }

    function closeCameraImmediate() {
        gameState.cameraOpen = false; sounds.fan.volume = 0.05;
        document.getElementById('camera-system').style.display = 'none';
        document.getElementById('monitor-opener').style.display = 'flex';
        document.getElementById('monitor-panel').style.transform = "translateY(100%)";
        startPowerDrain();
    }

    function switchCam(cam) {
        if(gameState.currentCam === cam) return;
        playSound('blip');
        gameState.currentCam = cam;
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('cam-selected'));
        document.getElementById(`btn-${cam}`).classList.add('cam-selected');
        
        // Foxy run trigger via cam switch to 2A
        if (cam === '2A') {
            let foxy = animatronics.find(a=>a.name==='Foxy');
            if (foxy && foxy.stage === 3 && !foxyRunPending) {
                foxyRunPending = true; playSound('run'); handleFoxyRun();
            }
        }

        renderCamera();
        triggerCamStatic(140); 
    }

    function renderCamera() {
        if(!gameState.cameraOpen) return;
        const c = document.getElementById('cam-content');
        document.getElementById('cam-label').innerText = `CAM ${gameState.currentCam}`;
        const feed = document.getElementById('cam-feed');
        
        let bg = `textures/cam${gameState.currentCam.toLowerCase()}.png`;
        
        if(gameState.currentCam === '6') { c.innerHTML = '<div style="font-size:30px;color:#555;">-CAMERA DISABLED-<br><br>AUDIO ONLY</div>'; feed.style.backgroundImage = 'none'; return; }
        
        if (gameState.currentCam === '1C') {
            let f = animatronics.find(a=>a.name==='Foxy');
            if (f) {
                if (f.stage === 0) bg = 'textures/cam1c.png';
                else if (f.stage === 1) bg = 'textures/cam1c2.png';
                else if (f.stage === 2) bg = 'textures/cam1c3.png';
                else if (f.stage === 3) bg = 'textures/cam1c4.png';
            }
        }
        
        feed.style.backgroundImage = `url('${bg}')`;
        c.innerHTML = '';

        animatronics.forEach(bot => {
            if(bot.location === gameState.currentCam) {
                if (gameState.currentCam === '1A') {
                    let style = '';
                    if (bot.name === 'Bonnie') style = 'left: 10%; bottom: 0; width: auto; height: 90%;';
                    if (bot.name === 'Chica') style = 'right: 10%; bottom: 0; width: auto; height: 90%;';
                    if (bot.name === 'Freddy') style = 'left: 50%; transform: translateX(-50%); bottom: 0; width: auto; height: 95%; z-index: 2;';
                    c.innerHTML += `<img src="textures/vrajs/${bot.name}_${gameState.currentCam}.png" style="position: absolute; object-fit: contain; ${style}">`;
                } else if(bot.name !== 'Foxy') {
                    c.innerHTML += `<img src="textures/vrajs/${bot.name}_${gameState.currentCam}.png" style="width:100%; height:100%; object-fit:cover;">`;
                }
            }
        });
        
        if(gameState.currentCam==='2A' && foxyRunPending) {
             c.innerHTML=`<img src="textures/vrajs/Foxy_2A.png" style="width:100%; height:100%; object-fit:cover;">`;
        }
    }

    let currentScroll = 0; const MAX_SCROLL = 20;
    document.addEventListener('mousemove', (e) => mouseX = e.clientX);

    function scrollLoop() {
        if(gameState.active && !gameState.cameraOpen) {
            const w = window.innerWidth;
            const t = w * 0.35;
            if(mouseX < t) currentScroll -= ((t-mouseX)/t)*1.5;
            else if(mouseX > w-t) currentScroll += ((mouseX-(w-t))/t)*1.5;
            if(currentScroll<0)currentScroll=0; if(currentScroll>MAX_SCROLL)currentScroll=MAX_SCROLL;
            document.getElementById('office').style.transform = `translateX(-${currentScroll}vw)`;
        }
        requestAnimationFrame(scrollLoop);
    }

    function triggerPowerOutage() {
        gameState.active = false;
        playSound('power'); sounds.fan.pause();
        closeCameraImmediate(); document.getElementById('office').style.background = '#000';
        document.getElementById('office').style.backgroundImage = 'none';
        document.getElementById('monitor-opener').style.display = 'none';
        ['left','right'].forEach(s => {
            document.getElementById(`shutter-${s}`).classList.remove('closed');
            document.getElementById(`window-${s}`).style.backgroundColor = 'transparent';
            document.getElementById(`doorway-${s}`).style.backgroundColor = '#050505';
        });
        setTimeout(() => triggerJumpscare({name:'Freddy'}), 5000);
    }

    function triggerJumpscare(bot) {
        if(!gameState.active && bot.name!=='Freddy' && bot.name!=='Golden Vraj') return;
        gameState.active = false;
        sounds.fan.pause(); playSound('jump');
        
        clearInterval(timerHour); clearInterval(powerTimer); clearInterval(timerAI);
        // Do not close camera here, so jumpscare overlays wherever you are currently looking
        document.getElementById('monitor-opener').style.display='none';
        
        const s = document.getElementById('game-over-screen'); s.style.display = 'flex';
        let tex = `textures/vrajs/${bot.name}_Jumpscare.png`;
        if (bot.name === 'Golden Vraj') tex = `textures/vrajs/golden_jumpscare.png`;
        
        document.getElementById('jumpscare-anim').innerHTML = `<img src="${tex}">`;
        
        setTimeout(() => {
            sounds.jump.pause();             // <--- AUDIO CUTS OUT IMMEDIATELY
            sounds.jump.currentTime = 0;
            const dStatic = document.getElementById('transition-static-death');
            dStatic.style.display = 'block';
            sounds.static.play(); 
            setTimeout(() => location.reload(), 2000);
        }, 1200);
    }

    function winGame() {
        gameState.active = false;
        sounds.fan.pause(); playSound('win');
        
        if(currentNight === 5) localStorage.setItem('vraj_star1', true);
        if(currentNight === 6) localStorage.setItem('vraj_star2', true);
        
        if(isCustomNight) {
            let b = parseInt(document.getElementById('ai-bonnie').value);
            let c = parseInt(document.getElementById('ai-chica').value);
            let f = parseInt(document.getElementById('ai-freddy').value);
            let x = parseInt(document.getElementById('ai-foxy').value);
            if(b===20 && c===20 && f===20 && x===20) localStorage.setItem('vraj_star3', true);
        }

        if(!isCustomNight && currentNight < 7) localStorage.setItem('vraj_night', currentNight+1);
        
        clearInterval(timerHour); clearInterval(powerTimer); clearInterval(timerAI);
        closeCameraImmediate(); document.getElementById('monitor-opener').style.display='none';
        
        document.getElementById('win-screen').classList.remove('hidden');
        document.getElementById('win-clock').innerText = "5 AM";
        
        setTimeout(() => {
            let ticks = 0;
            let clockAnim = setInterval(() => {
                ticks++;
                document.getElementById('win-clock').innerText = (ticks % 2 === 0) ? "5 AM" : "6 AM";
                if(ticks >= 5) {
                    clearInterval(clockAnim);
                    document.getElementById('win-clock').innerText = "6 AM";
                    
                    let confettiInterval = setInterval(() => {
                        for(let i=0; i<15; i++) {
                            let c = document.createElement('div');
                            c.className = 'confetti';
                            c.style.left = Math.random()*100 + 'vw';
                            c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                            c.style.animationDuration = (Math.random()*2+2)+'s';
                            document.body.appendChild(c);
                            setTimeout(() => { if(c.parentNode) c.parentNode.removeChild(c); }, 5000);
                        }
                    }, 200);

                    setTimeout(() => {
                        clearInterval(confettiInterval);
                        sounds.win.pause(); sounds.win.currentTime = 0;
                        const winScreen = document.getElementById('win-screen');
                        const vidScreen = document.getElementById('video-screen');
                        const vid = document.getElementById('intermission-video');
                        
                        triggerTransitionStatic(() => {
                            winScreen.classList.add('hidden');
                            if(isCustomNight) {
                                location.reload();
                            } else {
                                vidScreen.style.display = 'flex';
                                let vidSrc = `videos/video${currentNight}.mp4`;
                                vid.src = vidSrc;
                                vid.play().catch(e => { console.log("Video failed"); location.reload(); });
                                vid.onended = () => { triggerTransitionStatic(() => { location.reload(); }); };
                            }
                        });
                    }, 15000);
                }
            }, 400);
        }, 2000);
    }

    function updateUsageUI(lvl) {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`bar${i}`);
            if(i<=lvl) b.classList.add('usage-active'); else b.classList.remove('usage-active');
        }
    }
</script>
</body>
</html>
