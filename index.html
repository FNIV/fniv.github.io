<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FIVE NIGHTS IN VRAJ</title>
<style>
    /* --- CSS RESET & BASICS --- */
    * {
        /* Force uniform blocky terminal font for all text */
        font-family: 'Courier New', Courier, monospace !important;
    }

    body {
        margin: 0; padding: 0;
        background-color: #000; color: #fff;
        overflow: hidden; user-select: none;
        height: 100vh; width: 100vw;
    }
    img { pointer-events: none; user-drag: none; -webkit-user-drag: none; }
    .hidden { display: none !important; }
    .flex-center { display: flex; justify-content: center; align-items: center; }
    
    /* GLOBAL EFFECTS */
    .scanlines {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 2px, 3px 100%;
        pointer-events: none; z-index: 999; opacity: 0.6;
    }
    .vignette {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.8) 100%);
        pointer-events: none; z-index: 900;
    }

    /* --- LOADING SCREEN --- */
    #loading-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    #loading-text { font-size: 3rem; margin-bottom: 20px; font-weight: bold; }
    #loading-bar-container { width: 50%; height: 20px; border: 2px solid #fff; padding: 2px; }
    #loading-bar { width: 0%; height: 100%; background: #fff; transition: width 0.1s; }

    /* --- MENUS --- */
    #menu-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 1000; display: none;
        overflow: hidden;
    }

    /* Base Static Layer */
    .static-anim {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-size: cover; pointer-events: none; z-index: 10;
        animation: staticCycle 0.2s infinite;
    }
    /* Static Overlay Layer for 9 & 10 */
    .static-anim::after {
        content: "";
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-size: cover; pointer-events: none;
        opacity: 0.5;
        animation: extraStaticCycle 1.5s infinite;
    }
    
    .static-opaque { opacity: 1; }
    .static-transparent { opacity: 0.3; } 
    .static-cam { opacity: 1; } 

    @keyframes staticCycle {
        0%, 12% { background-image: url('textures/static1.png'); }
        13%, 24% { background-image: url('textures/static2.png'); }
        25%, 37% { background-image: url('textures/static3.png'); }
        38%, 49% { background-image: url('textures/static4.png'); }
        50%, 62% { background-image: url('textures/static5.png'); }
        63%, 74% { background-image: url('textures/static6.png'); }
        75%, 87% { background-image: url('textures/static7.png'); }
        88%, 100% { background-image: url('textures/static8.png'); }
    }
    @keyframes extraStaticCycle {
        0%, 85% { background-image: none; }
        86%, 92% { background-image: url('textures/static9.png'); }
        93%, 100% { background-image: url('textures/static10.png'); }
    }

    .menu-left {
        width: 30%; height: 100%; display: flex; flex-direction: column;
        justify-content: center; padding-left: 50px; z-index: 1002;
    }
    .menu-title {
        font-size: 4rem; color: #fff; font-weight: bold;
        text-shadow: 0 0 10px #fff; margin-bottom: 20px;
        border-left: 5px solid #a00; padding-left: 20px;
    }
    .menu-stars {
        display: flex; gap: 10px; margin-bottom: 20px; padding-left: 20px;
    }
    .star { font-size: 2rem; color: gold; text-shadow: 0 0 5px #ffaa00; display: none; }
    
    .menu-options { display: flex; flex-direction: column; gap: 15px; align-items: flex-start; }
    button.menu-btn {
        background: transparent; border: none; color: #ccc;
        font-size: 2rem; font-weight: bold;
        text-align: left; cursor: pointer; transition: 0.1s;
        text-shadow: 2px 2px 0 #000;
    }
    button.menu-btn:hover { color: #fff; transform: translateX(10px); }
    button.menu-btn:disabled { color: #555 !important; cursor: not-allowed !important; transform: none !important; }
    
    .menu-night-display { 
        font-size: 1.2rem; color: #666; margin-top: 10px; 
        transition: 0.1s; font-weight: bold;
    }
    
    .menu-right { width: 70%; height: 100%; position: absolute; right: 0; top: 0; overflow: hidden; z-index: 1; pointer-events: none;}
    
    @keyframes fadeInVraj { from { opacity: 0; } to { opacity: 0.5; } }
    #menu-animatronic {
        position: absolute; top: 10%; right: 0; width: 90%; height: 90%;
        object-fit: contain; opacity: 0.5; animation: fadeInVraj 2s ease-in-out;
    }

    #reset-progress-btn {
        position: absolute; bottom: 10px; left: 10px;
        background: transparent; border: none; color: #fff;
        font-size: 10px; font-weight: bold;
        opacity: 0.5; cursor: pointer; z-index: 2000; text-transform: uppercase;
    }
    #reset-progress-btn:hover { opacity: 1; }

    /* --- SOCIAL & FIREBASE PANEL (Full Height Right Side) --- */
    #social-panel {
        position: absolute; right: 0; top: 0; 
        width: 360px; height: 100%;
        background: rgba(10, 10, 10, 0.85); border-left: 2px solid #333;
        z-index: 1005; display: flex; flex-direction: column; padding: 15px;
        box-sizing: border-box; box-shadow: -5px 0 20px #000; pointer-events: auto;
    }
    .social-section { margin-bottom: 15px; display: flex; flex-direction: column; }
    .social-section h3 {
        margin: 0 0 5px 0; font-size: 1.2rem; color: #aaa; text-align: center;
        border-bottom: 1px solid #444; padding-bottom: 5px; text-shadow: 1px 1px 0 #000;
        position: relative;
    }
    .social-input-row { display: flex; gap: 5px; }
    .social-input {
        flex-grow: 1; background: #000; color: #fff; border: 1px solid #555;
        padding: 8px; font-weight: bold; outline: none;
    }
    .social-input:focus { border-color: #fff; }
    .social-btn {
        background: #222; color: #fff; border: 1px solid #555; cursor: pointer;
        font-weight: bold; padding: 5px 15px; transition: 0.1s;
    }
    .social-btn:hover { background: #fff; color: #000; }
    
    #chat-box, #history-box, #leaderboard-box {
        background: rgba(0,0,0,0.8); border: 1px solid #444; border-radius: 4px;
        overflow-y: auto; margin-bottom: 5px; padding: 10px;
        font-size: 0.9rem; word-wrap: break-word; box-shadow: inset 0 0 10px #000;
    }
    #chat-box, #history-box { flex-grow: 1; height: 0; }
    #leaderboard-box { height: 250px; }
    
    .tab-header { display: flex; justify-content: space-around; border-bottom: 1px solid #444; margin-bottom: 5px; padding-bottom: 5px; }
    .tab-btn { cursor: pointer; font-size: 1.1rem; font-weight: bold; color: #555; transition: 0.1s; }
    .tab-btn.active { color: #aaa; text-shadow: 1px 1px 0 #000; }
    .tab-btn:hover { color: #fff; }

    /* GLOBAL NOTIFICATION */
    #global-notification {
        position: fixed; top: -60px; left: 50%; transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9); border: 2px solid #555; color: #fff;
        padding: 10px 25px; font-weight: bold; font-size: 1.1rem; border-radius: 5px;
        z-index: 10000; transition: top 0.5s ease-out, opacity 0.5s ease-out;
        text-shadow: 1px 1px 0 #000; box-shadow: 0 5px 15px rgba(0,0,0,0.9);
        pointer-events: none; opacity: 0; text-align: center;
    }
    .notif-show { top: 20px !important; opacity: 1 !important; }

    /* CUSTOM NIGHT MENU */
    #custom-night-menu {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 1100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    #custom-night-menu .cn-content { z-index: 2; display: flex; flex-direction: column; align-items: center; width: 100%; }
    
    .cn-grid { 
        display: flex; gap: 40px; margin-bottom: 40px; 
        flex-wrap: nowrap; justify-content: center; width: 100%; 
    }
    .cn-char { text-align: center; font-weight: bold; width: 180px; }
    .cn-img { 
        width: 160px; height: 160px; object-fit: contain; 
        border: 4px solid #555; margin-bottom: 15px; background: #111; 
    }
    
    .cn-input::-webkit-outer-spin-button,
    .cn-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .cn-input {
        background: #000; color: #fff; font-size: 3.5rem; width: 100px; 
        text-align: center; border: 4px solid #555; font-weight: bold;
        -moz-appearance: textfield; padding: 5px;
    }
    
    .cn-controls { display: flex; gap: 30px; margin-top: 30px; }
    .cn-btn { font-size: 2rem; padding: 15px 50px; cursor: pointer; border: 2px solid #fff; background: #000; color: #fff; font-weight: bold; }
    .cn-btn:hover { background: #fff; color: #000; }

    /* CONFETTI */
    .confetti {
        position: absolute; width: 10px; height: 10px; 
        animation: fall linear forwards; z-index: 2002;
        top: -10px;
    }
    @keyframes fall { to { transform: translateY(105vh) rotate(720deg); } }

    /* GAME UI */
    #win-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .clock-box { font-size: 6rem; font-weight: bold; border: 4px solid #fff; padding: 20px; margin-bottom: 20px; z-index: 2001; background: #000; }

    #game-over-screen {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: transparent; z-index: 9999; display: none;
        justify-content: center; align-items: center; overflow: hidden;
    }
    
    #jumpscare-anim {
        width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;
        animation: lungeIn 0.05s ease-out forwards, crazyShake 0.05s 0.05s infinite;
        z-index: 9998;
    }
    #jumpscare-anim img {
        width: 100%; height: 100%; object-fit: contain;
        image-rendering: high-quality;
        filter: drop-shadow(0 0 50px rgba(0,0,0,1));
    }
    @keyframes lungeIn {
        0% { transform: scale(0.1) translateY(100px); opacity: 0; }
        100% { transform: scale(2.5) translateY(0); opacity: 1; }
    }
    @keyframes crazyShake {
        0% { transform: scale(2.5) translate(-40px, 30px) rotate(-4deg); filter: contrast(1.4) brightness(1.2); }
        25% { transform: scale(2.6) translate(40px, -30px) rotate(4deg); filter: contrast(1.1) brightness(0.9); }
        50% { transform: scale(2.4) translate(-20px, -40px) rotate(3deg); filter: contrast(1.5) brightness(1.3); }
        75% { transform: scale(2.7) translate(30px, 40px) rotate(-3deg); filter: contrast(1.0) brightness(1.0); }
        100% { transform: scale(2.5) translate(-40px, 30px) rotate(-4deg); filter: contrast(1.4) brightness(1.2); }
    }

    #help-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000 url('textures/help.png') no-repeat center center;
        background-size: contain; z-index: 3000; opacity: 0; display: none; pointer-events: none;
        transition: opacity 2s ease-in-out;
    }

    #video-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 4000; display: none;
        justify-content: center; align-items: center;
    }
    #intermission-video { width: 100%; height: 100%; object-fit: cover; }

    #ui-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 300; 
    }
    .hud-text { position: absolute; font-size: 1.5rem; font-weight: bold; text-shadow: 1px 1px 0 #000; pointer-events: none;}
    #time-display { top: 20px; right: 30px; }
    #night-display { top: 50px; right: 30px; font-size: 1rem; }
    #power-display { bottom: 55px; left: 30px; }
    #usage-label { position: absolute; bottom: 25px; left: 30px; font-weight: bold; font-size: 1.2rem; pointer-events: none;}
    #usage-box { position: absolute; bottom: 28px; left: 110px; display: flex; gap: 4px; pointer-events: none;}
    .usage-bar { width: 15px; height: 20px; background: #222; border: 1px solid #555; }
    .usage-active { background: #0f0; box-shadow: 0 0 5px #0f0; }

    /* IN-GAME ELEMENTS (Anchored inside the panning office room) */
    #mute-call-btn {
        position: absolute; bottom: 100px; left: 49%; transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6); border: 2px solid #555; border-radius: 5px;
        color: #fff; font-size: 1.5rem; padding: 10px 20px; font-weight: bold;
        cursor: pointer; z-index: 20; display: none; text-shadow: 2px 2px 0 #000;
        transition: background 0.1s, border-color 0.1s; pointer-events: auto;
    }
    #mute-call-btn:hover { background: rgba(255, 255, 255, 0.2); border-color: #fff; }

    #in-game-chat-container {
        position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
        width: 300px; display: none; flex-direction: column; z-index: 20; pointer-events: auto;
    }
    #in-game-chat-box {
        background: rgba(0,0,0,0.5); height: 100px; overflow-y: auto;
        border: 2px solid #555; padding: 5px; margin-bottom: 5px; font-size: 0.9rem;
        box-shadow: inset 0 0 10px #000; word-wrap: break-word; text-shadow: 1px 1px 0 #000;
    }
    #in-game-chat-input {
        background: rgba(0,0,0,0.8); color: #fff; border: 2px solid #555;
        padding: 5px; font-weight: bold; width: 100%; box-sizing: border-box; outline: none;
    }

    /* --- OFFICE --- */
    #office {
        width: 120vw; height: 100vh; 
        background: url('textures/office.png') no-repeat center center;
        background-size: cover; background-color: #1a1a1a;
        position: absolute; top: 0; left: 0;
    }
    .wall-section {
        position: absolute; top: 0; height: 100%; width: 18%; background: transparent;
        z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center;
        pointer-events: none; 
    }
    #wall-left { left: 0; } #wall-right { right: 0; }

    .control-panel {
        width: 80px; height: 160px; 
        background: linear-gradient(to right, #999, #eee, #999); 
        border: 4px solid #444; border-radius: 8px;
        display: flex; flex-direction: column; justify-content: space-around; align-items: center;
        box-shadow: 10px 10px 30px #000, inset 0 0 15px #000; 
        transform: perspective(500px) rotateY(5deg); pointer-events: auto;
    }
    .ctrl-btn {
        width: 55px; height: 55px; 
        border-radius: 5px; cursor: pointer;
        border: 3px solid #666; font-size: 11px; font-weight: bold;
        display: flex; justify-content: center; align-items: center; color: #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.8), inset 0 2px 5px rgba(255,255,255,0.5);
        transition: transform 0.05s, box-shadow 0.05s;
    }
    .btn-door { background: radial-gradient(circle, #e00, #800); border-color: #600; border-radius: 50%; }
    .btn-light { background: radial-gradient(circle, #fff, #bbb); color: #000; border-color: #888; border-radius: 4px; } 
    
    .btn-active-door { 
        background: radial-gradient(circle, #800, #400); 
        box-shadow: inset 0 6px 12px #000; 
        border-color: #f00; transform: translateY(4px); 
    }
    .btn-active-light { 
        background: radial-gradient(circle, #ddf, #88f); 
        box-shadow: 0 0 20px #fff, inset 0 6px 12px rgba(0,0,0,0.6); 
        border-color: #fff; transform: translateY(4px); 
    }

    .window-frame {
        width: 80%; height: 25%; margin-bottom: 20px;
        position: relative; overflow: hidden; pointer-events: auto;
        
        background: #050505; border: 8px solid #222; border-bottom: 12px solid #111; 
        border-radius: 4px; box-sizing: border-box;
        box-shadow: inset 0 0 20px #000, 5px 5px 15px rgba(0,0,0,0.8);
    }
    .window-glass {
        width: 100%; height: 100%; position: relative; 
        display: flex; justify-content: center; align-items: center;
        transition: background-color 0.1s ease-in-out;
        
        background-color: transparent;
        background-image: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 30%, rgba(255,255,255,0.02) 70%, rgba(255,255,255,0.1) 100%);
    }
    .window-glass::after {
        content: ""; position: absolute; top: 0; left: 50%; width: 8px; height: 100%;
        background: linear-gradient(90deg, #111, #333, #111);
        transform: translateX(-50%); z-index: 5;
        box-shadow: 2px 0 5px rgba(0,0,0,0.8), -2px 0 5px rgba(0,0,0,0.8);
    }
    .shadow-img { width: 90%; height: 90%; object-fit: contain; filter: brightness(0); opacity: 0.95; }

    .doorway {
        position: absolute; top: 15%; height: 70%; width: 15%; z-index: 1;
        display: flex; justify-content: center; align-items: center;
        transition: background-color 0.1s ease-in-out;
        
        background: #050505; 
        border: 10px solid #1a1a1a; border-bottom: none; border-radius: 10px 10px 0 0;
        box-shadow: inset 0 0 80px #000, 10px 0 20px rgba(0,0,0,0.9);
        box-sizing: border-box;
    }
    #doorway-left { left: 18%; } #doorway-right { right: 18%; }
    .animatronic-full { width: 100%; height: 100%; object-fit: contain; filter: brightness(0.7); }
    
    .door-shutter {
        position: absolute; top: 0; left: 0; width: 100%; height: 0%;
        background: url('textures/door.png'), repeating-linear-gradient(180deg, #333, #333 15px, #1a1a1a 15px, #1a1a1a 20px);
        background-size: cover; transition: height 0.2s linear; 
        border-bottom: 12px solid #444; z-index: 5; box-sizing: border-box;
        box-shadow: 0 10px 20px rgba(0,0,0,0.9);
    }
    .door-shutter.closed { height: 100%; }

    #monitor-panel {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 100%;
        background: #333; border: 20px solid #222; box-sizing: border-box;
        transform: translateY(100%); transition: transform 0.1s linear;
        z-index: 140; display: flex; justify-content: center; align-items: center; pointer-events: none;
    }
    #monitor-panel-inner { width: 90%; height: 90%; background: #111; border: 5px solid #555; }

    .trigger-bar {
        position: fixed; bottom: 0; left: 30%; width: 40%; height: 60px;
        z-index: 200; display: flex; justify-content: center; align-items: center;
        opacity: 0.3; transition: opacity 0.2s; cursor: pointer;
        border: 2px solid #555; background: rgba(255,255,255,0.05);
        border-top-left-radius: 10px; border-top-right-radius: 10px; pointer-events: auto;
    }
    .trigger-bar:hover { opacity: 0.9; background: rgba(255,255,255,0.2); }
    .arrow-container { width: 100%; display: flex; justify-content: space-between; padding: 0 40px; }
    .trigger-arrow { color: #fff; font-size: 3rem; text-shadow: 2px 2px 0 #000; letter-spacing: -5px; font-weight: bold; }

    #camera-system { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 150; display: none; }
    
    #map-ui { 
        position: absolute; bottom: 80px; right: 30px; width: 320px; height: 260px; z-index: 200; 
        transform: scale(1.3); transform-origin: bottom right; 
    }
    #map-blueprint { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 190; pointer-events: none; opacity: 0.9; }
    .line-style { fill: none; stroke: #eee; stroke-width: 3px; }

    .cam-btn {
        position: absolute; background: rgba(40, 40, 40, 0.6); border: 2px solid #bbb; color: #fff;
        font-weight: bold; font-size: 13px; 
        display: flex; justify-content: center; align-items: center; text-align: center;
        cursor: pointer; z-index: 200; transition: background 0.1s; box-sizing: border-box; 
    }
    .cam-btn:hover { background: rgba(80, 80, 80, 0.7); }
    .cam-selected { background: #adff2f !important; color: #000 !important; border-color: #fff !important; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.7; } }

    #btn-1A { top: 10px; left: 110px; width: 70px; height: 40px; } 
    #btn-1B { top: 60px; left: 100px; width: 90px; height: 50px; } 
    #btn-5  { top: 25px; left: 30px;  width: 55px; height: 35px; } 
    #btn-1C { top: 85px; left: 30px;  width: 45px; height: 45px; } 
    #btn-7  { top: 25px; left: 205px; width: 60px; height: 35px; } 
    #btn-6  { top: 80px; left: 215px; width: 60px; height: 45px; } 
    #btn-2A { top: 130px; left: 95px; width: 40px; height: 50px; } 
    #btn-2B { top: 195px; left: 95px; width: 40px; height: 35px; } 
    #btn-3  { top: 155px; left: 40px; width: 40px; height: 35px; } 
    #btn-4A { top: 130px; left: 155px; width: 40px; height: 50px; } 
    #btn-4B { top: 195px; left: 155px; width: 40px; height: 35px; } 

    #cam-feed { width: 100%; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; background-size: cover; background-position: center; }
    #cam-label { position: absolute; top: 30px; left: 30px; font-size: 2rem; border-left: 5px solid red; padding-left: 10px; text-shadow: 2px 2px #000; font-weight: bold;}
    #cam-content { font-size: 8rem; position: relative; display:flex; justify-content:center; align-items:center; width: 100%; height: 100%; }
    
    #transition-static { display:none; z-index: 9999; }
    #cam-move-static { display:none; z-index: 160; position:absolute; top:0; left:0; width:100%; height:100%; }
</style>
</head>
<body oncontextmenu="return false;" ondragstart="return false;">

<div id="global-notification">
    <span id="global-notif-text"></span>
</div>

<div id="loading-screen">
    <div id="loading-text">LOADING...</div>
    <div id="loading-bar-container"><div id="loading-bar"></div></div>
</div>

<div class="scanlines"></div>
<div class="vignette"></div>

<div id="menu-screen">
    <div class="static-anim static-transparent" style="z-index: 0;"></div>
    <div class="menu-left">
        <div class="menu-title">FIVE NIGHTS<br>IN VRAJ</div>
        <div class="menu-stars" id="menu-stars">
            <span class="star" id="star1">★</span>
            <span class="star" id="star2">★</span>
            <span class="star" id="star3">★</span>
        </div>
        <div class="menu-options">
            <button class="menu-btn" onclick="startNewGame()">New Game</button>
            <button class="menu-btn" onclick="continueGame()">Continue</button>
            <button class="menu-btn" id="btn-endless" onclick="startEndlessMode()">Endless Mode</button>
            <div class="menu-night-display" id="menu-night-text">Night 1</div>
        </div>
    </div>
    
    <div id="social-panel">
        <div class="social-section">
            <h3 style="position:relative;">PLAYER PROFILE
                <div style="position:absolute; right:0; top:0; font-size:1rem; color:#fff; display:flex; align-items:center; gap:5px;">
                    <span style="width:10px; height:10px; background-color:#0f0; border-radius:50%; box-shadow:0 0 5px #0f0;"></span>
                    <span id="online-count">1</span>
                </div>
            </h3>
            <div class="social-input-row">
                <input type="text" id="player-name-input" class="social-input" placeholder="Display Name..." maxlength="15">
                <button id="save-name-btn" class="social-btn">SAVE</button>
            </div>
        </div>

        <div class="social-section" style="flex-grow: 1; display: flex; flex-direction: column;">
            <div class="tab-header">
                <div class="tab-btn active" id="tab-chat" onclick="switchSocialTab('chat')">GLOBAL CHAT</div>
                <div class="tab-btn" id="tab-history" onclick="switchSocialTab('history')">HISTORY</div>
            </div>
            
            <div id="chat-box"><div style="color:#555; text-align:center; margin-top:20px;">Loading Chat...</div></div>
            <div id="history-box" class="hidden"><div style="color:#555; text-align:center; margin-top:20px;">Loading History...</div></div>
            
            <div class="social-input-row" id="chat-input-row">
                <input type="text" id="chat-input" class="social-input" placeholder="Type message... (Enter to send)" maxlength="60">
                <button id="send-chat-btn" class="social-btn">SEND</button>
            </div>
        </div>

        <div class="social-section">
            <h3>ENDLESS LEADERBOARD</h3>
            <div id="leaderboard-box">
                <div style="color:#555; text-align:center; margin-top:20px;">Loading Scores...</div>
            </div>
        </div>
    </div>

    <div class="menu-right"><img id="menu-animatronic" src="textures/menu1.png"></div>
    <button id="reset-progress-btn" onclick="resetProgress()">Reset Progress</button>
</div>

<div id="help-overlay"></div>

<div id="transition-static" class="static-anim static-opaque"></div>

<div id="custom-night-menu" class="hidden">
    <div class="static-anim static-transparent" style="z-index: 0;"></div>
    <div class="cn-content">
        <h1 style="font-size: 3rem; margin-bottom: 20px; font-weight: bold;">CUSTOM NIGHT</h1>
        <div class="cn-grid">
            <div class="cn-char">
                <img src="textures/vrajs/Bonnie_office.png" class="cn-img">
                <div style="margin-bottom:5px;">BONNIE</div>
                <input type="number" id="ai-bonnie" class="cn-input" min="0" max="20" value="0" onchange="capAI(this)">
            </div>
            <div class="cn-char">
                <img src="textures/vrajs/Chica_office.png" class="cn-img">
                <div style="margin-bottom:5px;">CHICA</div>
                <input type="number" id="ai-chica" class="cn-input" min="0" max="20" value="0" onchange="capAI(this)">
            </div>
            <div class="cn-char">
                <img src="textures/vrajs/Freddy_office.png" class="cn-img">
                <div style="margin-bottom:5px;">FREDDY</div>
                <input type="number" id="ai-freddy" class="cn-input" min="0" max="20" value="0" onchange="capAI(this)">
            </div>
            <div class="cn-char">
                <img src="textures/vrajs/Foxy_office.png" class="cn-img">
                <div style="margin-bottom:5px;">FOXY</div>
                <input type="number" id="ai-foxy" class="cn-input" min="0" max="20" value="0" onchange="capAI(this)">
            </div>
        </div>
        <div class="cn-controls">
            <button class="cn-btn" onclick="returnToMenu()">BACK</button>
            <button class="cn-btn" onclick="setAll20()">ALL 20</button>
            <button class="cn-btn" onclick="startCustomNight()">READY</button>
        </div>
    </div>
</div>

<div id="win-screen" class="hidden"><div class="clock-box" id="win-clock">5 AM</div><div style="font-size: 2rem; color: #888; font-weight: bold;">NIGHT COMPLETE</div></div>
<div id="game-over-screen">
    <div id="transition-static-death" class="static-anim static-opaque" style="z-index: 9999; display:none;"></div>
    <div id="jumpscare-anim" style="z-index: 2;"></div>
</div>

<div id="monitor-panel"><div id="monitor-panel-inner"></div></div>

<div id="video-screen">
    <video id="intermission-video" style="width:100%; height:100%; object-fit:cover;"></video>
</div>

<div id="ui-layer">
    <div id="time-display" class="hud-text">12 AM</div><div id="night-display" class="hud-text">Night 1</div>
    <div id="power-display" class="hud-text">Power: 100%</div><div id="usage-label">Usage:</div>
    <div id="usage-box"><div class="usage-bar" id="bar1"></div><div class="usage-bar" id="bar2"></div><div class="usage-bar" id="bar3"></div><div class="usage-bar" id="bar4"></div></div>
</div>

<div id="office">
    <img id="golden-vraj" src="textures/vrajs/golden.png">
    
    <div id="mute-call-btn" onclick="muteCall()">MUTE CALL</div>
    
    <div id="in-game-chat-container">
        <div id="in-game-chat-box"></div>
        <input type="text" id="in-game-chat-input" placeholder="Press Enter to chat..." maxlength="60">
    </div>
    
    <div class="wall-section" id="wall-left">
        <div class="window-frame"><div class="window-glass" id="window-left"></div></div>
        <div class="control-panel">
            <div class="ctrl-btn btn-door" id="btn-door-left" onclick="toggleDoor('left')">DOOR</div>
            <div class="ctrl-btn btn-light" id="btn-light-left" onmousedown="toggleLight('left', true)" onmouseup="toggleLight('left', false)" onmouseleave="toggleLight('left', false)">LIGHT</div>
        </div>
    </div>
    <div class="doorway" id="doorway-left"><div class="door-shutter" id="shutter-left"></div><div id="hall-left" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;"></div></div>

    <div class="wall-section" id="wall-right">
        <div class="window-frame"><div class="window-glass" id="window-right"></div></div>
        <div class="control-panel">
            <div class="ctrl-btn btn-door" id="btn-door-right" onclick="toggleDoor('right')">DOOR</div>
            <div class="ctrl-btn btn-light" id="btn-light-right" onmousedown="toggleLight('right', true)" onmouseup="toggleLight('right', false)" onmouseleave="toggleLight('right', false)">LIGHT</div>
        </div>
    </div>
    <div class="doorway" id="doorway-right"><div class="door-shutter" id="shutter-right"></div><div id="hall-right" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;"></div></div>
</div>

<div class="trigger-bar" id="monitor-opener" onmouseenter="toggleMonitor()"><div class="arrow-container"><div class="trigger-arrow">&gt;&gt;</div><div class="trigger-arrow">&lt;&lt;</div></div></div>

<div id="camera-system">
    <div class="static-anim static-transparent"></div>
    <div id="cam-move-static" class="static-anim static-cam"></div>
    
    <div id="cam-feed"><div id="cam-label">CAM 1A</div><div id="cam-content"></div></div>
    
    <div id="map-ui">
        <svg id="map-blueprint">
            <line class="line-style" x1="145" y1="50" x2="145" y2="60" />
            <line class="line-style" x1="85" y1="40" x2="100" y2="70" />
            <line class="line-style" x1="205" y1="40" x2="190" y2="70" />
            <line class="line-style" x1="75" y1="100" x2="100" y2="90" />
            <line class="line-style" x1="215" y1="100" x2="190" y2="90" />
            <line class="line-style" x1="115" y1="110" x2="115" y2="130" />
            <line class="line-style" x1="175" y1="110" x2="175" y2="130" />
            <line class="line-style" x1="115" y1="180" x2="115" y2="195" />
            <line class="line-style" x1="175" y1="180" x2="175" y2="195" />
            <line class="line-style" x1="80" y1="170" x2="95" y2="155" />
        </svg>

        <div class="cam-btn cam-selected" id="btn-1A" onclick="switchCam('1A')">CAM 1A</div>
        <div class="cam-btn" id="btn-1B" onclick="switchCam('1B')">CAM 1B</div>
        <div class="cam-btn" id="btn-5" onclick="switchCam('5')">CAM 5</div>
        <div class="cam-btn" id="btn-1C" onclick="switchCam('1C')">CAM 1C</div>
        <div class="cam-btn" id="btn-7" onclick="switchCam('7')">CAM 7</div>
        <div class="cam-btn" id="btn-6" onclick="switchCam('6')">CAM 6</div>
        <div class="cam-btn" id="btn-2A" onclick="switchCam('2A')">CAM 2A</div>
        <div class="cam-btn" id="btn-3" onclick="switchCam('3')">CAM 3</div>
        <div class="cam-btn" id="btn-2B" onclick="switchCam('2B')">CAM 2B</div>
        <div class="cam-btn" id="btn-4A" onclick="switchCam('4A')">CAM 4A</div>
        <div class="cam-btn" id="btn-4B" onclick="switchCam('4B')">CAM 4B</div>
    </div>
    
    <div class="trigger-bar" style="z-index: 300;" onmouseenter="toggleMonitor()"><div class="arrow-container"><div class="trigger-arrow">&gt;&gt;</div><div class="trigger-arrow">&lt;&lt;</div></div></div>
</div>

<script>
    const GAME_HOUR_DURATION = 80000; // 80 seconds per hour (8 mins total)
    const AI_MOVE_INTERVAL = 4970; // 4.97 seconds
    const JUMPSCARE_DURATION = 5000; 
    
    const imageList = [
        'textures/office.png', 'textures/door.png', 'textures/help.png', 
        'textures/menu1.png', 'textures/menu2.png', 'textures/menu3.png',
        'textures/static1.png', 'textures/static2.png', 'textures/static3.png',
        'textures/static4.png', 'textures/static5.png', 'textures/static6.png',
        'textures/static7.png', 'textures/static8.png', 'textures/static9.png', 'textures/static10.png',
        'textures/cam1a.png', 'textures/cam1b.png', 'textures/cam1c.png', 'textures/cam2a.png', 
        'textures/cam2b.png', 'textures/cam3.png', 'textures/cam4a.png', 'textures/cam4b.png', 
        'textures/cam5.png', 'textures/cam7.png',
        'textures/cam1c2.png', 'textures/cam1c3.png', 'textures/cam1c4.png',
        'textures/vrajs/Bonnie_1A.png', 'textures/vrajs/Bonnie_1B.png', 'textures/vrajs/Bonnie_5.png', 'textures/vrajs/Bonnie_2A.png', 'textures/vrajs/Bonnie_2B.png', 'textures/vrajs/Bonnie_3.png', 'textures/vrajs/Bonnie_office.png',
        'textures/vrajs/Chica_1A.png', 'textures/vrajs/Chica_1B.png', 'textures/vrajs/Chica_7.png', 'textures/vrajs/Chica_4A.png', 'textures/vrajs/Chica_4B.png', 'textures/vrajs/Chica_office.png',
        'textures/vrajs/Freddy_1A.png', 'textures/vrajs/Freddy_1B.png', 'textures/vrajs/Freddy_7.png', 'textures/vrajs/Freddy_4A.png', 'textures/vrajs/Freddy_4B.png', 'textures/vrajs/Freddy_office.png',
        'textures/vrajs/Foxy_2A.png', 'textures/vrajs/Foxy_office.png',
        'textures/vrajs/Freddy_Jumpscare.png', 'textures/vrajs/Bonnie_Jumpscare.png', 'textures/vrajs/Chica_Jumpscare.png', 'textures/vrajs/Foxy_Jumpscare.png', 'textures/vrajs/golden_jumpscare.png',
        'textures/vrajs/golden.png'
    ];

    const sounds = {
        fan: new Audio('sounds/fan.mp3'),
        door: new Audio('sounds/door.mp3'),
        light: new Audio('sounds/light.mp3'),
        monitorUp: new Audio('sounds/monitor_up.mp3'),
        monitorDown: new Audio('sounds/monitor_down.mp3'),
        blip: new Audio('sounds/blip.mp3'),
        static: new Audio('sounds/static.mp3'),
        laugh: new Audio('sounds/laugh.mp3'),
        run: new Audio('sounds/run.mp3'),
        bang: new Audio('sounds/bang.mp3'),
        power: new Audio('sounds/power_out.mp3'),
        jump: new Audio('sounds/jumpscare.mp3'),
        win: new Audio('sounds/6am.mp3'),
        menuMusic: new Audio('sounds/menu_music.mp3'),
        surprise: new Audio('sounds/suprise.mp3'), 
        hangup: new Audio('sounds/hangup.mp3') 
    };
    
    sounds.fan.loop = true; sounds.fan.volume = 0.05; sounds.fan.preload = 'auto';
    sounds.static.loop = true; sounds.static.volume = 0.3; sounds.static.preload = 'auto';
    sounds.light.loop = true; sounds.light.preload = 'auto';
    sounds.menuMusic.loop = true; sounds.menuMusic.preload = 'auto';
    if(sounds.surprise) sounds.surprise.preload = 'auto';
    if(sounds.hangup) sounds.hangup.preload = 'auto';

    let assetsLoaded = 0;
    const totalAssets = imageList.length;

    function preloadAssets() {
        if(totalAssets === 0) { showMenu(); return; }
        imageList.forEach(path => {
            const img = new Image();
            img.src = path;
            img.onload = () => { assetsLoaded++; updateLoadingBar(); };
            img.onerror = () => { console.log("Missing: " + path); assetsLoaded++; updateLoadingBar(); };
        });
    }

    function updateLoadingBar() {
        const pct = (assetsLoaded / totalAssets) * 100;
        document.getElementById('loading-bar').style.width = pct + '%';
        if(assetsLoaded >= totalAssets) setTimeout(showMenu, 500);
    }

    function showMenu() {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('menu-screen').style.display = 'flex';
        checkStars();
        
        let displayNight = currentNight;
        document.getElementById('menu-night-text').innerText = `Night ${displayNight}`;
        
        let btnEndless = document.getElementById('btn-endless');
        btnEndless.classList.remove('hidden');
        if (currentNight >= 6) {
            btnEndless.innerText = "Endless Mode";
            btnEndless.disabled = false;
        } else {
            btnEndless.innerText = "Endless Mode (Locked)";
            btnEndless.disabled = true;
        }
    }

    function resetProgress() {
        if (confirm("Are you sure you want to reset all progress?")) {
            localStorage.clear();
            location.reload();
        }
    }

    window.switchSocialTab = function(tab) {
        if(tab === 'chat') {
            document.getElementById('chat-box').classList.remove('hidden');
            document.getElementById('history-box').classList.add('hidden');
            document.getElementById('chat-input-row').style.display = 'flex';
            document.getElementById('tab-chat').classList.add('active');
            document.getElementById('tab-history').classList.remove('active');
        } else {
            document.getElementById('chat-box').classList.add('hidden');
            document.getElementById('history-box').classList.remove('hidden');
            document.getElementById('chat-input-row').style.display = 'none';
            document.getElementById('tab-chat').classList.remove('active');
            document.getElementById('tab-history').classList.add('active');
        }
    };

    preloadAssets();

    let currentNight = parseInt(localStorage.getItem('vraj_night')) || 1;
    let lastToggleTime = 0; let mouseX = window.innerWidth / 2; let isCustomNight = false;
    let goldenVrajActive = false; let goldenTimer = null;
    let foxyRunPending = false;
    
    let isEndlessMode = false;
    let endlessSeconds = 0;
    let endlessInterval = null;

    let powerTimer = null;
    let exactPower = 100.0;
    
    let currentCallAudio = null;
    let callTimeout = null;
    let muteBtnTimeout = null;

    // Surprise sound logic trackers
    let seenAtDoor = { left: false, right: false };

    const NIGHT_DIFFICULTY = { 1: [0,0,0,0,0], 2: [3,1,0,1,0], 3: [0,5,2,2,0], 4: [2,4,6,6,0], 5: [5,7,5,10,0], 6: [10,12,6,16,0] };
    let gameState = { active: false, hour: 0, power: 100, usage: 1, cameraOpen: false, currentCam: '1A', doors: {left:false,right:false}, lights: {left:false,right:false}, foxyBangs: 0 };
    
    // Adjacency Map for Realistic Movement
    const ADJACENCY = {
        'Bonnie': { '1A':['1B'], '1B':['5','2A'], '5':['1B'], '2A':['3','2B'], '3':['2A'], '2B':['door_left'] },
        'Chica': { '1A':['1B'], '1B':['7','4A'], '7':['1B'], '4A':['6','4B'], '6':['4A'], '4B':['door_right'] },
        'Freddy': { '1A':['1B'], '1B':['7'], '7':['6'], '6':['4A'], '4A':['4B'], '4B':['door_right'] } 
    };

    let animatronics = [
        { name: 'Bonnie', location: '1A', level: 0 },
        { name: 'Chica',  location: '1A', level: 0 },
        { name: 'Freddy', location: '1A', level: 0 },
        { name: 'Foxy',   location: '1C', level: 0, stage: 0, patience: 100 },
        { name: 'Golden Vraj', location: null, level: 0 } 
    ];
    let timerHour, timerAI, timerMenuAnim;

    function playSound(name) { if(sounds[name]) { sounds[name].currentTime = 0; sounds[name].play().catch(()=>{}); } }

    function checkStars() {
        if(localStorage.getItem('vraj_star1')) document.getElementById('star1').style.display = 'inline';
        if(localStorage.getItem('vraj_star2')) document.getElementById('star2').style.display = 'inline';
        if(localStorage.getItem('vraj_star3')) document.getElementById('star3').style.display = 'inline';
    }

    function capAI(input) {
        if(input.value > 20) input.value = 20;
        if(input.value < 0) input.value = 0;
    }

    // DEBUG CHEATS & HOTKEYS
    document.addEventListener('keydown', (e) => {
        if(e.target.tagName === 'INPUT') return;

        if(e.ctrlKey && e.shiftKey && e.code === 'KeyO') {
            localStorage.setItem('vraj_night', 7);
            location.reload();
        }
        if(e.ctrlKey && e.shiftKey && e.code === 'KeyP' && gameState.active) {
            if (!isEndlessMode) winGame(); 
        }
        if(e.code === 'KeyL' && gameState.active) {
            // Random Jumpscare for testing
            let availableBots = animatronics.filter(a => a.name !== 'Golden Vraj');
            let randomBot = availableBots[Math.floor(Math.random() * availableBots.length)];
            triggerJumpscare(randomBot);
        }
    });

    document.body.addEventListener('click', () => {
        if(document.getElementById('menu-screen').style.display !== 'none') {
            sounds.menuMusic.play().catch(()=>{});
        }
    }, {once:true});

    // MENU TWITCH ANIMATION
    timerMenuAnim = setInterval(() => {
        const img = document.getElementById('menu-animatronic');
        if(Math.random() > 0.7) {
            img.src = Math.random() > 0.5 ? 'textures/menu2.png' : 'textures/menu3.png';
            setTimeout(() => { img.src = 'textures/menu1.png'; }, 80);
        }
    }, 800);

    function triggerTransitionStatic(callback) {
        const s = document.getElementById('transition-static');
        s.style.display = 'block';
        sounds.static.currentTime = 0; sounds.static.play();
        setTimeout(() => {
            s.style.display = 'none';
            sounds.static.pause();
            if(callback) callback();
        }, 250);
    }

    function triggerCamStatic(duration = 140) {
        if(gameState.cameraOpen) {
            const s = document.getElementById('cam-move-static');
            s.style.display = 'block';
            setTimeout(() => { s.style.display = 'none'; }, duration); 
        }
    }

    function startNewGame() { 
        triggerTransitionStatic(() => {
            currentNight = 1; localStorage.setItem('vraj_night', 1); isCustomNight = false; isEndlessMode = false; launchNight(); 
        });
    }
    
    function continueGame() { 
        if (currentNight >= 7) {
            openCustomNight();
            return;
        }
        if(currentNight > 5 && currentNight < 7) currentNight = 6; 
        isCustomNight = false; 
        isEndlessMode = false;
        triggerTransitionStatic(() => { launchNight(); });
    }
    
    function openCustomNight() { 
        document.getElementById('menu-screen').classList.add('hidden'); 
        document.getElementById('custom-night-menu').classList.remove('hidden'); 
    }
    
    function setAll20() {
        document.getElementById('ai-bonnie').value = 20;
        document.getElementById('ai-chica').value = 20;
        document.getElementById('ai-freddy').value = 20;
        document.getElementById('ai-foxy').value = 20;
    }

    function startCustomNight() {
        isCustomNight = true;
        isEndlessMode = false;
        let b = parseInt(document.getElementById('ai-bonnie').value)||0; 
        let c = parseInt(document.getElementById('ai-chica').value)||0;
        let f = parseInt(document.getElementById('ai-freddy').value)||0; 
        let x = parseInt(document.getElementById('ai-foxy').value)||0;
        
        NIGHT_DIFFICULTY[7] = [b,c,f,x,0]; 
        currentNight = 7;
        document.getElementById('custom-night-menu').classList.add('hidden'); 
        triggerTransitionStatic(() => { launchNight(); });
    }

    function startEndlessMode() {
        isEndlessMode = true;
        isCustomNight = false;
        document.getElementById('menu-screen').classList.add('hidden');
        triggerTransitionStatic(() => { launchNight(); });
    }

    function returnToMenu() { location.reload(); }

    function launchNight() {
        sounds.menuMusic.pause(); sounds.menuMusic.currentTime = 0; 
        document.getElementById('menu-screen').classList.add('hidden'); 
        document.getElementById('win-screen').classList.add('hidden'); 
        document.getElementById('game-over-screen').style.display = 'none';
        
        if (isEndlessMode) {
            animatronics.forEach(a => { if (a.name !== 'Golden Vraj') a.level = 5; });
        } else {
            let levels = NIGHT_DIFFICULTY[currentNight] || [20,20,20,20,20];
            animatronics.forEach((a, i) => a.level = levels[i]);
        }
        
        resetGame();

        if (currentNight === 1 && !isCustomNight && !isEndlessMode) {
            const help = document.getElementById('help-overlay');
            help.style.display = 'block'; help.style.opacity = 1;
            setTimeout(() => {
                help.style.opacity = 0;
                setTimeout(() => { help.style.display = 'none'; startGameLoop(); }, 2000);
            }, 5000);
        } else { startGameLoop(); }
    }

    function startGameLoop() {
        gameState.active = true;
        exactPower = 100.0;
        sounds.fan.play().catch(()=>{});
        
        document.getElementById('in-game-chat-container').style.display = 'flex';
        
        if (isEndlessMode) {
            endlessSeconds = 0;
            updateEndlessDisplay();
            endlessInterval = setInterval(updateEndlessTime, 1000);
        } else {
            timerHour = setInterval(updateTime, GAME_HOUR_DURATION); 
        }
        
        timerAI = setInterval(updateAI, AI_MOVE_INTERVAL);
        startPowerDrain(); 
        requestAnimationFrame(scrollLoop); 
        renderCamera();

        // Phone Call Logic
        if (!isCustomNight && !isEndlessMode && currentNight <= 6) {
            callTimeout = setTimeout(() => {
                if (gameState.active && gameState.power > 0) {
                    currentCallAudio = new Audio(`sounds/call${currentNight}.mp3`);
                    currentCallAudio.play().catch(e => console.log("No call audio for this night."));
                    
                    muteBtnTimeout = setTimeout(() => {
                        if (gameState.active && currentCallAudio && !currentCallAudio.paused) {
                            document.getElementById('mute-call-btn').style.display = 'block';
                        }
                    }, 2000);

                    currentCallAudio.onended = () => {
                        document.getElementById('mute-call-btn').style.display = 'none';
                    };
                }
            }, 5000);
        }
    }

    function muteCall() {
        if (currentCallAudio) {
            currentCallAudio.pause();
            currentCallAudio.currentTime = 0;
        }
        playSound('hangup');
        document.getElementById('mute-call-btn').style.display = 'none';
    }

    function updateEndlessTime() {
        if(!gameState.active) return;
        endlessSeconds++;
        updateEndlessDisplay();
        
        if (endlessSeconds % 60 === 0) {
            animatronics.forEach(a => { 
                if (a.name !== 'Golden Vraj') {
                    a.level++; 
                }
            });
        }
    }

    function updateEndlessDisplay() {
        let m = String(Math.floor(endlessSeconds / 60)).padStart(2, '0');
        let s = String(endlessSeconds % 60).padStart(2, '0');
        document.getElementById('time-display').innerText = `${m}:${s}`;
    }

    function resetGame() {
        gameState = { active: false, hour: 0, power: 100, usage: 1, cameraOpen: false, currentCam: '1A', doors: {left:false,right:false}, lights: {left:false,right:false}, foxyBangs: 0 };
        animatronics.forEach(a => { if(a.name!=='Golden Vraj') a.location = '1A'; });
        let foxy = animatronics.find(a=>a.name==='Foxy'); foxy.location = '1C'; foxy.stage = 0; foxy.patience = 100;
        foxyRunPending = false;
        
        clearInterval(powerTimer); powerTimer = null; exactPower = 100.0;
        clearInterval(endlessInterval); endlessInterval = null;

        if (currentCallAudio) { currentCallAudio.pause(); currentCallAudio = null; }
        clearTimeout(callTimeout); clearTimeout(muteBtnTimeout);
        document.getElementById('mute-call-btn').style.display = 'none';
        document.getElementById('in-game-chat-container').style.display = 'none';

        goldenVrajActive = false; clearTimeout(goldenTimer); document.getElementById('golden-vraj').style.display = 'none';
        seenAtDoor = { left: false, right: false }; // Reset sightings

        if (isEndlessMode) {
            document.getElementById('night-display').innerText = "Endless Mode";
            document.getElementById('time-display').innerText = "00:00";
        } else {
            document.getElementById('night-display').innerText = isCustomNight ? "Custom Night" : `Night ${currentNight}`;
            document.getElementById('time-display').innerText = "12 AM";
        }

        document.getElementById('power-display').innerText = "Power: 100%";
        ['left', 'right'].forEach(side => {
            document.getElementById(`shutter-${side}`).classList.remove('closed');
            document.getElementById(`btn-door-${side}`).classList.remove('btn-active-door');
            document.getElementById(`btn-light-${side}`).classList.remove('btn-active-light');
            document.getElementById(`window-${side}`).style.backgroundColor = 'transparent';
            document.getElementById(`doorway-${side}`).style.backgroundColor = '#050505';
            document.getElementById(`window-${side}`).innerHTML = ''; document.getElementById(`hall-${side}`).innerHTML = '';
        });
        document.getElementById('monitor-opener').style.display = 'flex';
        closeCameraImmediate();
    }

    function updateTime() {
        if(!gameState.active) return;
        gameState.hour++;
        let disp = gameState.hour === 0 ? 12 : gameState.hour;
        document.getElementById('time-display').innerText = `${disp} AM`;
        
        if(!isCustomNight) {
            let b = animatronics[0]; let c = animatronics[1]; let f = animatronics[3]; 
            if(currentNight === 1) {
                if(gameState.hour === 2) b.level = 1;
                if(gameState.hour === 3) { b.level = 2; c.level = 1; f.level = 1; }
                if(gameState.hour === 4) { b.level = 3; c.level = 2; f.level = 2; }
            } else if(currentNight === 2) {
                if(gameState.hour === 3) { b.level+=1; c.level+=1; f.level+=1; }
            } else if(currentNight === 3) {
                if(gameState.hour === 3) { b.level+=1; c.level+=1; f.level+=1; }
            }
        }

        if(gameState.hour === 6) winGame();
    }

    function startPowerDrain() {
        let usage = 1;
        if(gameState.doors.left) usage++; if(gameState.doors.right) usage++;
        if(gameState.lights.left) usage++; if(gameState.lights.right) usage++;
        if(gameState.cameraOpen) usage++;
        
        gameState.usage = usage; 
        let displayUsage = Math.min(usage, 4);
        updateUsageUI(displayUsage);

        if (!powerTimer && gameState.active) {
            powerTimer = setInterval(() => {
                if(!gameState.active) return;
                
                // Exact FNAF 1 proportional drain logic. 
                // 1 bar = 9.6 seconds to drop 1% -> 1/96th drop per 100ms.
                exactPower -= (gameState.usage / 96);
                gameState.power = Math.ceil(exactPower);
                
                if(gameState.power <= 0) { 
                    gameState.power = 0; exactPower = 0;
                    document.getElementById('power-display').innerText = `Power: 0%`;
                    clearInterval(powerTimer); powerTimer = null;
                    triggerPowerOutage(); 
                } else {
                    document.getElementById('power-display').innerText = `Power: ${gameState.power}%`;
                }
            }, 100);
        }
    }

    function updateAI() {
        if(!gameState.active) return;
        updateFoxy();
        
        animatronics.forEach(bot => { 
            if(bot.name === 'Foxy' || bot.name === 'Golden Vraj') return; 
            if(Math.random()*20 < bot.level) moveBot(bot); 
        });
        if(gameState.lights.left) toggleLight('left', true); if(gameState.lights.right) toggleLight('right', true);
        renderCamera();
    }
    
    function updateFoxy() {
        let foxy = animatronics.find(a=>a.name==='Foxy');
        if(foxy.stage === 3 && foxyRunPending === false && !gameState.cameraOpen) {
        } else if (foxy.stage < 3) {
            if(gameState.cameraOpen && gameState.currentCam === '1C') foxy.patience = Math.min(foxy.patience + 5, 100); 
            else foxy.patience -= foxy.level;

            if(foxy.patience <= 0) {
                if(gameState.cameraOpen && gameState.currentCam === '1C') triggerCamStatic(400);
                foxy.stage++;
                foxy.patience = 100;
                if(foxy.stage === 3) foxy.location = '2A';
            }
        }
    }

    function checkGoldenVrajSpawn() {
        let chance = 0.001 * currentNight;
        if(isCustomNight || isEndlessMode) chance = 0.05; 
        if (!goldenVrajActive && Math.random() < chance) spawnGoldenVraj();
    }

    function spawnGoldenVraj() {
        goldenVrajActive = true;
        document.getElementById('golden-vraj').style.display = 'block';
        sounds.laugh.play(); 
        goldenTimer = setTimeout(() => {
            if (goldenVrajActive && gameState.active) {
                triggerJumpscare({ name: 'Golden Vraj' });
            }
        }, 1500);
    }

    function moveBot(bot) {
        if(bot.name === 'Freddy' && Math.random() > 0.5) playSound('laugh');
        
        let oldLoc = bot.location;
        
        // Attack/Door Logic
        if(bot.location === 'door_left') { 
            if(!gameState.doors.left) { triggerJumpscare(bot); return; }
            else { 
                bot.location = '1B'; 
                seenAtDoor.left = false; // Reset surprise sound
            }
        } else if(bot.location === 'door_right') { 
            if(!gameState.doors.right) { triggerJumpscare(bot); return; }
            else { 
                bot.location = '1B'; 
                seenAtDoor.right = false; // Reset surprise sound
            }
        } else {
            // Normal Movement
            let possibleMoves = ADJACENCY[bot.name][bot.location];
            if(possibleMoves) {
                let nextLoc = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
                
                if(bot.name === 'Freddy') {
                   if(bot.location === '4A') nextLoc = '4B'; 
                   if(bot.location === '4B') {
                       if(gameState.cameraOpen && gameState.currentCam === '4B') return; 
                       else nextLoc = 'door_right';
                   }
                }

                if(gameState.cameraOpen && (gameState.currentCam === oldLoc || gameState.currentCam === nextLoc)) {
                    triggerCamStatic(400);
                }
                
                // Reset surprise sound if entering door state
                if (nextLoc === 'door_left') seenAtDoor.left = false;
                if (nextLoc === 'door_right') seenAtDoor.right = false;

                bot.location = nextLoc;
            }
        }
    }
    
    function handleFoxyRun() {
        let foxy = animatronics.find(a=>a.name==='Foxy');
        foxy.location = 'door_left'; 
        
        setTimeout(() => {
             if(gameState.active) {
                 if(gameState.doors.left) { 
                     gameState.foxyBangs++;
                     let penalty = 1 + ((gameState.foxyBangs - 1) * 5); // 1%, 6%, 11%, 16%...
                     exactPower -= penalty;
                     gameState.power = Math.ceil(exactPower);
                     
                     playSound('bang'); 
                     
                     if (gameState.power <= 0) {
                         gameState.power = 0; exactPower = 0;
                         document.getElementById('power-display').innerText = `Power: 0%`;
                         triggerPowerOutage();
                     } else {
                         document.getElementById('power-display').innerText = `Power: ${gameState.power}%`;
                     }
                     
                     foxy.stage = Math.random() > 0.5 ? 0 : 1; 
                     foxy.location = '1C'; foxy.patience = 100;
                 } else { triggerJumpscare(foxy); }
                 foxyRunPending = false; 
             }
        }, 2000); 
    }

    function toggleDoor(side) {
        if(!gameState.active || gameState.power <= 0) return;
        playSound('door');
        gameState.doors[side] = !gameState.doors[side];
        const shutter = document.getElementById(`shutter-${side}`);
        const btn = document.getElementById(`btn-door-${side}`);
        if(gameState.doors[side]) { shutter.classList.add('closed'); btn.classList.add('btn-active-door'); }
        else { shutter.classList.remove('closed'); btn.classList.remove('btn-active-door'); }
        startPowerDrain();
    }

    function toggleLight(side, on) {
        if(!gameState.active || gameState.power <= 0) return;
        gameState.lights[side] = on;
        startPowerDrain(); 
        if(on) { sounds.light.currentTime = 0; sounds.light.play(); } 
        else { sounds.light.pause(); sounds.light.currentTime = 0; }
        
        const win = document.getElementById(`window-${side}`);
        const door = document.getElementById(`doorway-${side}`);
        const hall = document.getElementById(`hall-${side}`);
        const btn = document.getElementById(`btn-light-${side}`);

        if(on) {
            win.style.backgroundColor = 'rgba(200, 220, 255, 0.3)';
            door.style.backgroundColor = 'rgba(200, 220, 255, 0.3)'; 
            btn.classList.add('btn-active-light');
            let bot = null;
            if(side==='left') bot = animatronics.find(a=>a.name==='Bonnie'&&a.location==='door_left') || animatronics.find(a=>a.name==='Foxy'&&a.stage===3);
            if(side==='right') bot = animatronics.find(a=>a.name==='Chica'&&a.location==='door_right') || animatronics.find(a=>a.name==='Freddy'&&a.location==='door_right');
            
            if(bot) {
                // Trigger Surprise Sound if first time seeing them at door this encounter
                if(!seenAtDoor[side] && bot.name !== 'Foxy') {
                    playSound('surprise');
                    seenAtDoor[side] = true;
                }

                win.innerHTML = `<img src="textures/vrajs/${bot.name}_office.png" class="shadow-img">`; 
                if(!gameState.doors[side]) hall.innerHTML = `<img src="textures/vrajs/${bot.name}_office.png" class="animatronic-full">`; 
                else hall.innerHTML = '';
            } else { win.innerHTML = ''; hall.innerHTML = ''; }
        } else {
            win.style.backgroundColor = 'transparent'; door.style.backgroundColor = '#050505';
            win.innerHTML = ''; hall.innerHTML = ''; btn.classList.remove('btn-active-light');
        }
    }

    function toggleMonitor() {
        if (!gameState.active || gameState.power <= 0) return;
        let now = Date.now();
        if (now - lastToggleTime < 250) return; 
        lastToggleTime = now;

        const p = document.getElementById('monitor-panel');
        const trig = document.getElementById('monitor-opener');
        const sys = document.getElementById('camera-system');

        if (!gameState.cameraOpen) {
            sounds.monitorUp.currentTime = 0; sounds.monitorUp.play();
            sounds.fan.volume = 0.02; 
            if(goldenVrajActive) { goldenVrajActive = false; clearTimeout(goldenTimer); document.getElementById('golden-vraj').style.display='none'; }
            
            p.style.transform = "translateY(0%)";
            setTimeout(() => {
                gameState.cameraOpen = true; sys.style.display = 'block'; trig.style.display = 'none';
                p.style.transition = 'none'; p.style.transform = "translateY(100%)";
                void p.offsetWidth; p.style.transition = "transform 0.1s linear";
                renderCamera();
                startPowerDrain();
            }, 150);
        } else {
            sounds.monitorDown.currentTime = 0; sounds.monitorDown.play();
            sounds.fan.volume = 0.05; 
            
            // Foxy run check on closing monitor
            let foxy = animatronics.find(a=>a.name==='Foxy');
            if(foxy.stage === 3 && !foxyRunPending) { 
                foxyRunPending = true; playSound('run'); handleFoxyRun(); 
            }

            p.style.transition = 'none'; p.style.transform = "translateY(0%)";
            void p.offsetWidth; p.style.transition = "transform 0.1s linear";
            sys.style.display = 'none'; gameState.cameraOpen = false;
            requestAnimationFrame(() => p.style.transform = "translateY(100%)");
            setTimeout(() => { trig.style.display = 'flex'; checkGoldenVrajSpawn(); startPowerDrain(); }, 150);
        }
    }

    function closeCameraImmediate() {
        gameState.cameraOpen = false; sounds.fan.volume = 0.05;
        document.getElementById('camera-system').style.display = 'none';
        document.getElementById('monitor-opener').style.display = 'flex';
        document.getElementById('monitor-panel').style.transform = "translateY(100%)";
        startPowerDrain();
    }

    function switchCam(cam) {
        if(gameState.currentCam === cam) return;
        playSound('blip');
        gameState.currentCam = cam;
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('cam-selected'));
        document.getElementById(`btn-${cam}`).classList.add('cam-selected');
        
        // Foxy run trigger via cam switch to 2A
        if (cam === '2A') {
            let foxy = animatronics.find(a=>a.name==='Foxy');
            if (foxy && foxy.stage === 3 && !foxyRunPending) {
                foxyRunPending = true; playSound('run'); handleFoxyRun();
            }
        }

        renderCamera();
        triggerCamStatic(140); 
    }

    function renderCamera() {
        if(!gameState.cameraOpen) return;
        const c = document.getElementById('cam-content');
        document.getElementById('cam-label').innerText = `CAM ${gameState.currentCam}`;
        const feed = document.getElementById('cam-feed');
        
        let bg = `textures/cam${gameState.currentCam.toLowerCase()}.png`;
        
        if(gameState.currentCam === '6') { c.innerHTML = '<div style="font-size:30px;color:#555;">-CAMERA DISABLED-<br><br>AUDIO ONLY</div>'; feed.style.backgroundImage = 'none'; return; }
        
        if (gameState.currentCam === '1C') {
            let f = animatronics.find(a=>a.name==='Foxy');
            if (f) {
                if (f.stage === 0) bg = 'textures/cam1c.png';
                else if (f.stage === 1) bg = 'textures/cam1c2.png';
                else if (f.stage === 2) bg = 'textures/cam1c3.png';
                else if (f.stage === 3) bg = 'textures/cam1c4.png';
            }
        }
        
        feed.style.backgroundImage = `url('${bg}')`;
        c.innerHTML = '';

        animatronics.forEach(bot => {
            if(bot.location === gameState.currentCam) {
                if (gameState.currentCam === '1A') {
                    let style = '';
                    if (bot.name === 'Bonnie') style = 'left: 10%; bottom: 0; width: auto; height: 90%;';
                    if (bot.name === 'Chica') style = 'right: 10%; bottom: 0; width: auto; height: 90%;';
                    if (bot.name === 'Freddy') style = 'left: 50%; transform: translateX(-50%); bottom: 0; width: auto; height: 95%; z-index: 2;';
                    c.innerHTML += `<img src="textures/vrajs/${bot.name}_${gameState.currentCam}.png" style="position: absolute; object-fit: contain; ${style}">`;
                } else if(bot.name !== 'Foxy') {
                    c.innerHTML += `<img src="textures/vrajs/${bot.name}_${gameState.currentCam}.png" style="width:100%; height:100%; object-fit:cover;">`;
                }
            }
        });
        
        if(gameState.currentCam==='2A' && foxyRunPending) {
             c.innerHTML=`<img src="textures/vrajs/Foxy_2A.png" style="width:100%; height:100%; object-fit:cover;">`;
        }
    }

    let currentScroll = 0; const MAX_SCROLL = 20;
    document.addEventListener('mousemove', (e) => mouseX = e.clientX);

    function scrollLoop() {
        if(gameState.active && !gameState.cameraOpen) {
            const w = window.innerWidth;
            const t = w * 0.35;
            if(mouseX < t) currentScroll -= ((t-mouseX)/t)*1.5;
            else if(mouseX > w-t) currentScroll += ((mouseX-(w-t))/t)*1.5;
            if(currentScroll<0)currentScroll=0; if(currentScroll>MAX_SCROLL)currentScroll=MAX_SCROLL;
            document.getElementById('office').style.transform = `translateX(-${currentScroll}vw)`;
        }
        requestAnimationFrame(scrollLoop);
    }

    function triggerPowerOutage() {
        if(!gameState.active && gameState.power > 0) return;
        gameState.active = false;
        clearInterval(powerTimer); powerTimer = null;
        playSound('power'); sounds.fan.pause();
        
        if (currentCallAudio) { currentCallAudio.pause(); currentCallAudio = null; }
        document.getElementById('mute-call-btn').style.display = 'none';
        document.getElementById('in-game-chat-container').style.display = 'none';
        
        closeCameraImmediate(); document.getElementById('office').style.background = '#000';
        document.getElementById('office').style.backgroundImage = 'none';
        document.getElementById('monitor-opener').style.display = 'none';
        ['left','right'].forEach(s => {
            document.getElementById(`shutter-${s}`).classList.remove('closed');
            document.getElementById(`window-${s}`).style.backgroundColor = 'transparent';
            document.getElementById(`doorway-${s}`).style.backgroundColor = '#050505';
        });
        setTimeout(() => triggerJumpscare({name:'Freddy'}), 5000);
    }

    function triggerJumpscare(bot) {
        if(!gameState.active && bot.name!=='Freddy' && bot.name!=='Golden Vraj') return;
        
        if (isEndlessMode && window.submitEndlessScore) {
            window.submitEndlessScore(endlessSeconds);
        }

        if(gameState.active && window.logActivity) window.logActivity('death', bot.name);

        gameState.active = false;
        sounds.fan.pause(); playSound('jump');
        
        clearInterval(timerHour); clearInterval(powerTimer); clearInterval(timerAI); powerTimer = null;
        clearInterval(endlessInterval); endlessInterval = null;

        if (currentCallAudio) { currentCallAudio.pause(); currentCallAudio = null; }
        document.getElementById('mute-call-btn').style.display = 'none';
        document.getElementById('in-game-chat-container').style.display = 'none';

        document.getElementById('monitor-opener').style.display='none';
        
        const s = document.getElementById('game-over-screen'); s.style.display = 'flex';
        let tex = `textures/vrajs/${bot.name}_Jumpscare.png`;
        if (bot.name === 'Golden Vraj') tex = `textures/vrajs/golden_jumpscare.png`;
        
        document.getElementById('jumpscare-anim').innerHTML = `<img src="${tex}">`;
        
        setTimeout(() => {
            sounds.jump.pause();
            sounds.jump.currentTime = 0;
            const dStatic = document.getElementById('transition-static-death');
            dStatic.style.display = 'block';
            sounds.static.play(); 
            setTimeout(() => location.reload(), 2000);
        }, 1200);
    }

    function winGame() {
        if(gameState.active) {
            let winDetail = isCustomNight ? 'Custom Night' : (isEndlessMode ? 'Endless Mode' : 'Night '+currentNight);
            if(window.logActivity) window.logActivity('win', winDetail);
        }

        gameState.active = false;
        sounds.fan.pause(); playSound('win');
        
        if(currentNight === 5) localStorage.setItem('vraj_star1', true);
        if(currentNight === 6) localStorage.setItem('vraj_star2', true);
        
        if(isCustomNight) {
            let b = parseInt(document.getElementById('ai-bonnie').value);
            let c = parseInt(document.getElementById('ai-chica').value);
            let f = parseInt(document.getElementById('ai-freddy').value);
            let x = parseInt(document.getElementById('ai-foxy').value);
            if(b===20 && c===20 && f===20 && x===20) localStorage.setItem('vraj_star3', true);
        }

        if(!isCustomNight && currentNight < 7) localStorage.setItem('vraj_night', currentNight+1);
        
        clearInterval(timerHour); clearInterval(powerTimer); clearInterval(timerAI); powerTimer = null;
        
        if (currentCallAudio) { currentCallAudio.pause(); currentCallAudio = null; }
        document.getElementById('mute-call-btn').style.display = 'none';
        document.getElementById('in-game-chat-container').style.display = 'none';
        
        closeCameraImmediate(); document.getElementById('monitor-opener').style.display='none';
        
        document.getElementById('win-screen').classList.remove('hidden');
        document.getElementById('win-clock').innerText = "5 AM";
        
        setTimeout(() => {
            let ticks = 0;
            let clockAnim = setInterval(() => {
                ticks++;
                document.getElementById('win-clock').innerText = (ticks % 2 === 0) ? "5 AM" : "6 AM";
                if(ticks >= 5) {
                    clearInterval(clockAnim);
                    document.getElementById('win-clock').innerText = "6 AM";
                    
                    let confettiInterval = setInterval(() => {
                        for(let i=0; i<15; i++) {
                            let c = document.createElement('div');
                            c.className = 'confetti';
                            c.style.left = Math.random()*100 + 'vw';
                            c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                            c.style.animationDuration = (Math.random()*2+2)+'s';
                            document.body.appendChild(c);
                            setTimeout(() => { if(c.parentNode) c.parentNode.removeChild(c); }, 5000);
                        }
                    }, 200);

                    setTimeout(() => {
                        clearInterval(confettiInterval);
                        sounds.win.pause(); sounds.win.currentTime = 0;
                        const winScreen = document.getElementById('win-screen');
                        const vidScreen = document.getElementById('video-screen');
                        const vid = document.getElementById('intermission-video');
                        
                        triggerTransitionStatic(() => {
                            winScreen.classList.add('hidden');
                            if(isCustomNight) {
                                location.reload();
                            } else {
                                vidScreen.style.display = 'flex';
                                let vidSrc = `videos/video${currentNight}.mp4`;
                                vid.src = vidSrc;
                                vid.play().catch(e => { console.log("Video failed"); location.reload(); });
                                vid.onended = () => { triggerTransitionStatic(() => { location.reload(); }); };
                            }
                        });
                    }, 15000);
                }
            }, 400);
        }, 2000);
    }

    function updateUsageUI(lvl) {
        for(let i=1; i<=4; i++) {
            const b = document.getElementById(`bar${i}`);
            if(i<=lvl) b.classList.add('usage-active'); else b.classList.remove('usage-active');
        }
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";
    import { getFirestore, collection, addDoc, setDoc, doc, query, where, getDocs, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBn2LuoY0ZqHnz2nVx3ZidRVPv3GgAYRGU",
        authDomain: "fniv-f6e02.firebaseapp.com",
        projectId: "fniv-f6e02",
        storageBucket: "fniv-f6e02.firebasestorage.app",
        messagingSenderId: "752134357498",
        appId: "1:752134357498:web:705930bd9e349413b42443",
        measurementId: "G-QKNGMXXLQJ"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // UNIQUE PLAYER IDENTIFIER
    let userUID = localStorage.getItem('vraj_uid');
    if (!userUID) {
        userUID = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('vraj_uid', userUID);
    }

    let playerName = localStorage.getItem('vraj_playerName') || "Guest" + Math.floor(Math.random() * 1000);
    document.getElementById('player-name-input').value = playerName;

    // ONLINE PRESENCE PING
    setInterval(() => {
        setDoc(doc(db, "fniv_users", userUID), {
            name: playerName,
            nameLower: playerName.toLowerCase(),
            lastActive: Date.now()
        }, { merge: true });
    }, 10000);

    // GET ONLINE PLAYERS
    onSnapshot(collection(db, "fniv_users"), (snapshot) => {
        let now = Date.now();
        let count = 0;
        snapshot.forEach((doc) => {
            let data = doc.data();
            if (now - data.lastActive < 25000) count++; 
        });
        document.getElementById('online-count').innerText = count;
    });

    // SAVE UNIQUE NAME LOGIC
    document.getElementById('save-name-btn').addEventListener('click', async () => {
        let newName = document.getElementById('player-name-input').value.trim();
        if (newName && newName.toLowerCase() !== playerName.toLowerCase()) {
            
            const qName = query(collection(db, "fniv_users"), where("nameLower", "==", newName.toLowerCase()));
            const querySnapshot = await getDocs(qName);
            let taken = false;
            querySnapshot.forEach((d) => {
                if (d.id !== userUID) taken = true;
            });
            
            if (taken) {
                alert("That name is already taken! Try another.");
                document.getElementById('player-name-input').value = playerName;
            } else {
                playerName = newName;
                localStorage.setItem('vraj_playerName', playerName);
                await setDoc(doc(db, "fniv_users", userUID), {
                    name: playerName,
                    nameLower: playerName.toLowerCase(),
                    lastActive: Date.now()
                });
                alert("Name saved: " + playerName);
            }
        } else if (newName.toLowerCase() === playerName.toLowerCase()) {
            alert("Name saved: " + playerName);
        }
    });

    function escapeHTML(str) {
        return str ? str.replace(/[&<>'"]/g, tag => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
        }[tag])) : '';
    }

    // Chat System Global Function
    window.submitChatMessage = async (text) => {
        if (!text) return;
        try {
            await addDoc(collection(db, "fniv_chat"), {
                name: playerName,
                message: text,
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Chat Error: ", e);
        }
    };

    // Chat Listeners
    const chatBoxMenu = document.getElementById('chat-box');
    const chatBoxInGame = document.getElementById('in-game-chat-box');
    const qChat = query(collection(db, "fniv_chat"), orderBy("timestamp", "desc"), limit(30));
    
    onSnapshot(qChat, (snapshot) => {
        chatBoxMenu.innerHTML = '';
        chatBoxInGame.innerHTML = '';
        let msgs = [];
        snapshot.forEach((doc) => msgs.push(doc.data()));
        msgs.reverse(); 

        msgs.forEach(msg => {
            let htmlStr = `<div style="margin-bottom:5px;"><strong style="color:#aaa;">${escapeHTML(msg.name)}:</strong> <span style="color:#fff;">${escapeHTML(msg.message)}</span></div>`;
            chatBoxMenu.innerHTML += htmlStr;
            chatBoxInGame.innerHTML += htmlStr;
        });
        chatBoxMenu.scrollTop = chatBoxMenu.scrollHeight;
        chatBoxInGame.scrollTop = chatBoxInGame.scrollHeight;
    });

    // Enter Key Logic - Menu Chat
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('send-chat-btn').click();
    });
    document.getElementById('send-chat-btn').addEventListener('click', () => {
        let msgInput = document.getElementById('chat-input');
        window.submitChatMessage(msgInput.value.trim());
        msgInput.value = '';
    });

    // Enter Key Logic - In-Game Chat
    document.getElementById('in-game-chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            window.submitChatMessage(e.target.value.trim());
            e.target.value = '';
        }
    });

    // Leaderboard System
    const lbBox = document.getElementById('leaderboard-box');
    const qLb = query(collection(db, "fniv_leaderboard"), orderBy("score", "desc"), limit(10));

    onSnapshot(qLb, (snapshot) => {
        lbBox.innerHTML = '';
        let rank = 1;
        snapshot.forEach((doc) => {
            let data = doc.data();
            let div = document.createElement('div');
            div.style.marginBottom = '5px';
            div.innerHTML = `<span style="color:gold;">#${rank}</span> <strong style="color:#aaa;">${escapeHTML(data.name)}</strong> - <span style="color:#fff;">${data.timeString}</span>`;
            lbBox.appendChild(div);
            rank++;
        });
        if(rank === 1) lbBox.innerHTML = '<div style="color:#555; text-align:center; margin-top:20px;">No scores yet.</div>';
    });

    window.submitEndlessScore = async (seconds) => {
        if (seconds <= 0) return;
        let m = String(Math.floor(seconds / 60)).padStart(2, '0');
        let s = String(seconds % 60).padStart(2, '0');
        let timeStr = `${m}:${s}`;
        
        try {
            await addDoc(collection(db, "fniv_leaderboard"), {
                name: playerName,
                score: seconds,
                timeString: timeStr,
                timestamp: serverTimestamp()
            });
        } catch (e) {}
    };

    // Global Activity Logging (Wins / Deaths)
    window.logActivity = async (type, detail) => {
        try {
            await addDoc(collection(db, "fniv_activity"), {
                name: playerName,
                type: type,
                detail: detail,
                timestamp: serverTimestamp(),
                clientTime: Date.now()
            });
        } catch (e) {}
    };

    let initialActivityLoad = true;
    const historyBox = document.getElementById('history-box');
    const qActivity = query(collection(db, "fniv_activity"), orderBy("timestamp", "desc"), limit(30));
    
    onSnapshot(qActivity, (snapshot) => {
        historyBox.innerHTML = '';
        let activities = [];
        snapshot.forEach((doc) => activities.push(doc.data()));
        activities.reverse();
        
        activities.forEach(act => {
            let htmlStr = `<div style="margin-bottom:5px; border-bottom:1px solid #333; padding-bottom:5px;">`;
            if(act.type === 'death') {
                htmlStr += `<strong style="color:gold;">${escapeHTML(act.name)}</strong> was killed by <span style="color:#f55; font-weight:bold;">${escapeHTML(act.detail)}</span>`;
            } else if(act.type === 'win') {
                htmlStr += `<strong style="color:gold;">${escapeHTML(act.name)}</strong> survived <span style="color:#5f5; font-weight:bold;">${escapeHTML(act.detail)}</span>`;
            }
            htmlStr += `</div>`;
            historyBox.innerHTML += htmlStr;
        });
        historyBox.scrollTop = historyBox.scrollHeight;
        
        // Pop Global Notification if it's a new event
        if(!initialActivityLoad && snapshot.docChanges().length > 0) {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    let act = change.doc.data();
                    if(Date.now() - act.clientTime < 10000) { 
                        showGlobalNotification(act);
                    }
                }
            });
        }
        initialActivityLoad = false;
    });

    function showGlobalNotification(act) {
        let notif = document.getElementById('global-notification');
        let text = document.getElementById('global-notif-text');
        
        if(act.type === 'death') {
            text.innerHTML = `<span style="color:gold;">${escapeHTML(act.name)}</span> was killed by <span style="color:#f55;">${escapeHTML(act.detail)}</span>!`;
        } else if (act.type === 'win') {
            text.innerHTML = `<span style="color:gold;">${escapeHTML(act.name)}</span> survived <span style="color:#5f5;">${escapeHTML(act.detail)}</span>!`;
        }
        
        notif.classList.add('notif-show');
        setTimeout(() => { notif.classList.remove('notif-show'); }, 4000);
    }
</script>
</body>
</html>
